!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):e.$$TEA=r()}(this,function(){"use strict";var e=function(){return(e=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++){r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e}).apply(this,arguments)},r={request:function(e){if(BK.isBrowser){if(XMLHttpRequest){var r=new XMLHttpRequest;r.open(e.method,e.url,!0),Object.keys(e.headers).forEach(function(t){r.setRequestHeader(t,e.headers[t])}),r.onload=function(){try{var t=JSON.parse(r.responseText);e.success(t)}catch(r){e.fail()}},r.onerror=function(t){r.abort(),e.fail()},r.send(JSON.stringify(e.data))}}else BK.Http.request({url:e.url,method:e.method,headers:e.headers,body:JSON.stringify(e.data),success:function(r){try{var t=r.jsonObject();e.success(t)}catch(r){e.fail()}},fail:function(){e.fail()}})},setTimeout:function(e,r){BK.isBrowser?setTimeout&&setTimeout(e,r):BK.Director.ticker.setTimeout(e,r)},console:{info:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var t;BK.isBrowser?console&&console.info&&console.info.apply(console,e):(t=BK.Console).log.apply(t,e)},log:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var t;BK.isBrowser?console&&console.log&&console.log.apply(console,e):(t=BK.Console).log.apply(t,e)},error:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var t;BK.isBrowser?console&&console.error&&console.error.apply(console,e):(t=BK.Console).error.apply(t,e)},warn:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var t;BK.isBrowser?console&&console.warn&&console.warn.apply(console,e):(t=BK.Console).log.apply(t,e)}},localStorage:{setItem:function(e,r){return BK.isBrowser?localStorage&&localStorage.setItem?localStorage.setItem(e,r):void 0:BK.localStorage.setItem(e,r)},getItem:function(e){return BK.isBrowser?localStorage&&localStorage.getItem?localStorage.getItem(e):void 0:BK.localStorage.getItem(e)}},autoDetectEnvInfo:function(e){if(!BK.isBrowser){var r=BK.getSystemInfoSync();e("os_version",r.osVersion),e("network_type",r.networkType),e("os_name",r.platform),e("platform","qqplay"),e("qq_ver",r.QQVer)}}},t="__tea_cache_",n="https://mcs.snssdk.com",s="tea-sdk:",o=new(function(){function e(){var e=this;this.init=function(r){e.isLog=r},this.info=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var o;e.isLog&&(o=r.console).info.apply(o,[s].concat(t))},this.error=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var o;e.isLog&&(o=r.console).error.apply(o,[s].concat(t))},this.warn=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var o;e.isLog&&(o=r.console).warn.apply(o,[s].concat(t))},this.isLog=!1}return e}()),i=new(function(){function e(){this.get=function(e){var t="";try{var n=r.localStorage.getItem(e);n&&(t=n=JSON.parse(n))}catch(e){o.error(e.message)}return t},this.set=function(e,t){try{r.localStorage.setItem(e,t)}catch(e){o.error(e)}}}return e}()),a=void 0,u=new(function(){function s(){var s=this;this.initDeviceInfo=function(){r.autoDetectEnvInfo(s.set)},this.checkUserToken=function(e){s.appId=e;var r=t+"tokens_"+e;s.tokensKey=r;var n=i.get(r);return n&&n.user_unique_id&&n.web_id&&n.ssid?(s.envInfo.user.user_unique_id=n.user_unique_id,s.envInfo.user.web_id=n.web_id,s.envInfo.user.ssid=n.ssid,o.warn("初始化已经检测到了 webid ssid user_id，一般情况下不需要再次验证 id 了"),s.unlock(),!1):s.requestWebId(e)},this.requestWebId=function(e){s.isRequestWebId=!0,r.request({url:n+"/v1/user/webid",method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},data:{app_id:e,url:"location.href",user_agent:"navigator.userAgent",referer:"referer",user_unique_id:""},success:function(e){if(0!==e.e)o.error("请求 webid 失败~");else{s.isRequestWebId=!1,s.envInfo.user.ssid=e.ssid,s.envInfo.user.web_id=e.web_id,s.envInfo.user.user_unique_id=e.web_id;var r={web_id:e.web_id,ssid:e.ssid,user_unique_id:e.web_id};i.set(s.tokensKey,JSON.stringify(r)),s.waitForVerifyTokens?(s.lock(),s.verifyTokens(s.realUuid)):(s.unlock(),s.callback&&s.callback())}},fail:function(){s.isRequestWebId=!1,o.error("获取 webid 失败，数据将不会被上报")}})},this.verifyTokens=function(r){var t=s.tokensKey;if(s.waitForVerifyTokens=!1,s.realUuid=""+r,s.isRequestWebId)return s.waitForVerifyTokens=!0,o.warn("正在请求 webid，requestSsid 将会在前者请求完毕之后被调用"),!1;var n=i.get(t);if(n.user_unique_id===s.realUuid&&n.ssid&&n.web_id)o.warn("用户身份验证完毕：",JSON.stringify(n,null,2)),o.warn("传入的 user_id/user_unique_id 与 缓存中的完全一致，无需再次请求"),s.unlock();else{s.lock(),s.envInfo.user.user_unique_id=s.realUuid;var a=e({},i.get(t),{user_unique_id:s.realUuid});i.set(t,JSON.stringify(a)),s.requestSsid()}},this.requestSsid=function(){var t=s.tokensKey,a=i.get(t);r.request({url:n+"/v1/user/ssid",method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},data:{app_id:s.appId,web_id:a.web_id,user_unique_id:""+a.user_unique_id},success:function(r){if(s.unlock(),0!==r.e)o.error("请求 ssid 失败~");else{s.envInfo.user.ssid=r.ssid;var n=e({},a,{ssid:r.ssid});i.set(t,JSON.stringify(n)),o.warn("根据 user_unique_id 更新 ssid 成功！注意：在这之前不应该有数据被发出去"),s.callback&&s.callback()}},fail:function(){s.unlock(),o.error("根据 user_unique_id 获取新 ssid 失败")}})},this.set=function(e,r){"os_version"===e&&(r+=""),"app_id"===e&&s.checkUserToken(r),"user_unique_id"===e&&s.verifyTokens(r),s.envInfo.user.hasOwnProperty(e)?"user_type"===e?(r=Number(r),s.envInfo.user[e]=Number(r)):"user_id"===e?(s.envInfo.user[e]=String(r),s.envInfo.user.user_unique_id=String(r)):s.envInfo.user[e]=String(r):s.envInfo.header.hasOwnProperty(e)?s.envInfo.header[e]=r:s.envInfo.header.headers.hasOwnProperty(e)?s.envInfo.header.headers[e]=r:s.envInfo.header.headers.custom[e]=r},this.get=function(){for(var r={user:{},header:{headers:{custom:{}}}},t=s.envInfo,n=t.user,o=0,i=Object.keys(n);o<i.length;o++)n[_=i[o]]!==a&&(r.user[_]=n[_]);for(var u=t.header,c=0,f=Object.keys(u);c<f.length;c++)u[_=f[c]]!==a&&"headers"!==_&&(r.header[_]=u[_]);for(var l=t.header.headers,d=0,h=Object.keys(l);d<h.length;d++)"custom"!==(_=h[d])&&l[_]!==a&&(r.header.headers[_]=l[_]);var v=t.header.headers.custom,g=Object.keys(v);if(g.length)for(var p=0,y=g;p<y.length;p++){var _=y[p];r.header.headers.custom[_]=v[_]}else delete r.header.headers.custom;return{user:r.user,header:e({},r.header,{headers:JSON.stringify(r.header.headers)})}},this.envInfo={user:{user_id:a,web_id:a,user_unique_id:a,ssid:a,user_type:a},header:{app_id:a,app_name:a,os_name:a,os_version:a,device_model:a,ab_client:a,ab_version:a,traffic_type:a,utm_source:a,utm_medium:a,utm_campaign:a,headers:{platform:a,sdk_version:a,browser:a,browser_version:a,region:a,province:a,city:a,language:a,timezone:a,tz_offset:a,resolution:a,screen_height:a,screen_width:a,referrer:a,referrer_host:a,custom:{}}}},this.initDeviceInfo(),this.isRequestWebId=!1,this.waitForVerifyTokens=!1,this.realUuid=""}return s.prototype.lock=function(){this.isUserTokensReady=!1},s.prototype.unlock=function(){this.isUserTokensReady=!0},s}()),c=new(function(){function e(){var e=this;this.set=function(r,t){e.cache[r]=t},this.get=function(r){var t=[],n=e.cache[r];if(n)for(var s=0,o=n;s<o.length;s++){var i=o[s];t.push(i)}else t=[];return t},this.clean=function(r){e.cache[r]=void 0},this.cache={}}return e}()),f=function(e,t,n){var s=+new Date+Math.floor(1e5*Math.random());r.request({url:"https://mcs.snssdk.com/v1/list?tea_sdk_random="+s,method:"POST",headers:{"Content-Type":"text/plain; charset=utf-8"},data:e,success:function(r){"string"==typeof r?(o.error("数据上报失败"),n()):(0===r.e?o.warn("数据上报成功: ",e):(o.error("数据上报失败！","错误码："+r.e),o.error("为了避免后续上报数据被阻塞，sdk 将不再重试上报本数据，数据实体将会从 localstorage 清除")),t())},fail:function(){o.error("数据上报失败"),n()}})},l=function(){function n(){var n=this;this.setReady=function(e){n.isReady=e,n.report()},this.setEvtParams=function(r){n.evtParams=e({},n.evtParams,r)},this.event=function(e){var t=n.cacheKey,s=c.get(t)||[];s.push(e),c.set(t,s),s.length>=5?n.report():r.setTimeout(function(){n.report()},45)},this.report=function(){if(!n.isReady)return!1;if(!u.isUserTokensReady)return!1;var e=n.cacheKey,r=c.get(e);c.clean(e);var t=n.mergeEvts(r),s=i.get(e)||[],o=t.concat(s);if(!o.length)return!1;if(n.setSCcacheData(o),n.isReporting)return!1;var a=o.length;if(!a)return!1;var f=0,l=null;a<=n.sliceLength?(f=a,l=o):(f=n.sliceLength,l=o.slice(a-n.sliceLength)),n.sendData(l,f)},this.sendData=function(e,t){n.isReporting=!0;var s=n.cacheKey;f(e,function(){n.isReporting=!1;var e=i.get(s),r=e.length,o=e.slice(0,r-t);i.set(s,JSON.stringify(o)),n.report()},function(){n.isReporting=!1,r.setTimeout(function(){n.report()},3e3)})},this.setSCcacheData=function(e){i.set(n.cacheKey,JSON.stringify(e))},this.mergeEvts=function(e){if(!e.length)return[];for(var r={events:[],user:{},header:{}},t=n.evtParams,s=Object.keys(t),o=0,i=e;o<i.length;o++){for(var a=i[o],c=0,f=s;c<f.length;c++){var l=f[c];void 0===a.params[l]&&(a.params[l]=t[l])}var d=JSON.stringify(a.params);a.params=d}r.events=e;var h=u.get();return r.events=e,r.user=h.user,r.header=h.header,[r]},this.isReady=!1,this.isReporting=!1,this.sliceLength=10,this.cacheKey=t+"events",this.evtParams={}}return n}(),d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};return new(function(){function e(){var e=this;this.getConfig=function(){return u.get()},this.init=function(e){if("number"!=typeof e)throw new Error("app_id must be a number");u.set("app_id",e)},this.config=function(r){if(e.channel.setReady(!1),"object"!==(void 0===r?"undefined":d(r)))throw new Error("config param must be {}");r.log&&(o.init(Boolean(r.log)),o.info("logger 功能开启")),o.info("当前配置项：",JSON.stringify(r,null,2));var t=Object.keys(r);if(!t.length)return!1;for(var n=0,s=t;n<s.length;n++){var i=s[n],a=r[i];"evtParams"===i?e.channel.setEvtParams(a):"_staging_flag"===i?(a+""=="1"&&o.warn("根据_staging_flag设置，数据将会上报到stag 表。"),e.channel.setEvtParams({_staging_flag:a})):"log"!==i&&u.set(i,a)}},this.send=function(){u.isUserTokensReady?(o.warn("看到本提示，意味着用户信息已完全就绪，上报通道打开"),o.info("用户信息",JSON.stringify(u.get().user,null,2)),e.channel.setReady(!0)):e.callbackSend=!0},this.event=function(r,t){t||(t={}),"object"!==(void 0===t?"undefined":d(t))&&o.error("事件params 必须是{}:","event(event: string, params: object)");var n={event:r,params:t,local_time_ms:+new Date};e.channel.event(n)},this.callbackSend=!1,this.channel=new l,this.reportUrl="https://mcs.snssdk.com",u.callback=function(){e.callbackSend&&e.send()}}return e}())});
