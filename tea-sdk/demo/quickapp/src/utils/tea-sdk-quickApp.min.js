"use strict";function __awaiter(e,n,t,r){return new(t||(t=Promise))(function(s,i){function o(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){e.done?s(e.value):new t(function(n){n(e.value)}).then(o,a)}u((r=r.apply(e,n||[])).next())})}function __generator(e,n){function t(e){return function(n){return r([e,n])}}function r(t){if(s)throw new TypeError("Generator is already executing.");for(;u;)try{if(s=1,i&&(o=2&t[0]?i.return:t[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,t[1])).done)return o;switch(i=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,i=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(o=u.trys,!(o=o.length>0&&o[o.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){u.label=t[1];break}if(6===t[0]&&u.label<o[1]){u.label=o[1],o=t;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(t);break}o[2]&&u.ops.pop(),u.trys.pop();continue}t=n.call(e,u)}catch(e){t=[6,e],i=0}finally{s=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}var s,i,o,a,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a}var __assign=function(){return(__assign=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++){n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e}).apply(this,arguments)},TEA_CACHE_PREFIX="__tea_cache_",REPORT_PREFIX="https://mcs.snssdk.com",Logger=function(){function e(){var e=this;this.init=function(n){e.isLog=n},this.info=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];e.isLog&&console.log.apply(console,["tea-miniProduct-sdk: "].concat(n))},this.error=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];e.isLog&&(console.log(" "),console.error.apply(console,["tea-miniProduct-sdk: "].concat(n)),console.log(" "))},this.warn=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];e.isLog&&console.warn.apply(console,["tea-miniProduct-sdk: "].concat(n))},this.isLog=!1}return e}(),logger=new Logger,storage=require("@system.storage"),StorageCache=function(){function e(){this.get=function(e){return new Promise(function(n,t){storage.get({key:e,success:function(e){e&&(e=JSON.parse(e)),n(e)},fail:function(e,n){logger.error("handling fail, code = "+n),t({data:e,code:n})}})})},this.set=function(e,n){return new Promise(function(t,r){storage.set({key:e,value:n,success:function(e){t()},fail:function(e,n){logger.error("handling fail, code = "+n),r()}})})}}return e}(),StorageManager=new StorageCache,fetch=require("@system.fetch"),device=require("@system.device"),network=require("@system.network"),undef=void 0,Env=function(){function e(){var e=this;this.initDeviceInfo=function(){var n=e;device&&device.getInfo&&device.getInfo({success:function(e){n.set("brand",e.brand),n.set("manufacturer",e.manufacturer),n.set("device_model",e.model),n.set("product",e.product),n.set("os_name",e.osType),n.set("os_version",e.osVersionName),n.set("os_version_code",e.osVersionCode),n.set("platform_version_name",e.platformVersionName),n.set("platform_version_code",e.platformVersionCode),n.set("language",e.language),n.set("region",e.language),n.set("resolution",e.screenWidth+"x"+e.screenHeight),n.set("screen_width",e.screenWidth),n.set("screen_height",e.screenHeight)}}),network&&network.getType&&network.getType({success:function(e){n.set("network_type",e.type),n.set("network_metered",e.metered)}})},this.checkUserToken=function(n){return __awaiter(e,void 0,void 0,function(){var e,t;return __generator(this,function(r){switch(r.label){case 0:return this.appId=n,e=TEA_CACHE_PREFIX+"tokens_"+n,this.tokensKey=e,[4,StorageManager.get(e)];case 1:return t=r.sent(),t&&t.user_unique_id&&t.web_id&&t.ssid?(this.envInfo.user.user_unique_id=t.user_unique_id,this.envInfo.user.web_id=t.web_id,this.envInfo.user.ssid=t.ssid,console.warn("初始化已经检测到了 webid ssid user_id，一般情况下不需要再次验证 id 了"),this.unlock(),[2,!1]):[2,this.requestWebId(n)]}})})},this.requestWebId=function(n){return __awaiter(e,void 0,void 0,function(){var e=this;return __generator(this,function(t){return this.isRequestWebId=!0,fetch.fetch({url:REPORT_PREFIX+"/v1/user/webid",method:"POST",data:JSON.stringify({app_id:n,url:"location.href",user_agent:"navigator.userAgent",referer:"referer",user_unique_id:""}),header:{"Content-Type":"application/json; charset=utf-8"},success:function(n){return __awaiter(e,void 0,void 0,function(){var e,t;return __generator(this,function(r){switch(r.label){case 0:return 0===(e=JSON.parse(n.data)).e?[3,1]:(console.error("请求 webid 失败~"),[3,3]);case 1:return this.isRequestWebId=!1,this.envInfo.user.ssid=e.ssid,this.envInfo.user.web_id=e.web_id,this.envInfo.user.user_unique_id=e.web_id,t={web_id:e.web_id,ssid:e.ssid,user_unique_id:e.web_id},[4,StorageManager.set(this.tokensKey,JSON.stringify(t))];case 2:r.sent(),this.waitForVerifyTokens?(this.lock(),this.verifyTokens(this.realUuid)):(this.unlock(),this.callback&&this.callback()),r.label=3;case 3:return[2]}})})},fail:function(){e.isRequestWebId=!1,console.error("获取 webid 失败，数据将不会被上报")}}),[2]})})},this.verifyTokens=function(n){return __awaiter(e,void 0,void 0,function(){var e,t,r;return __generator(this,function(s){switch(s.label){case 0:return e=this.tokensKey,this.waitForVerifyTokens=!1,this.realUuid=""+n,this.isRequestWebId?(this.waitForVerifyTokens=!0,console.warn("正在请求 webid，requestSsid 将会在前者请求完毕之后被调用"),[2,!1]):[3,1];case 1:return[4,StorageManager.get(e)];case 2:return(t=s.sent()).user_unique_id===this.realUuid&&t.ssid&&t.web_id?(console.warn("用户身份验证完毕：",JSON.stringify(t,null,2)),console.warn("传入的 user_id/user_unique_id 与 缓存中的完全一致，无需再次请求"),this.unlock(),[3,5]):[3,3];case 3:return this.lock(),this.envInfo.user.user_unique_id=this.realUuid,r=__assign({},t,{user_unique_id:this.realUuid}),[4,StorageManager.set(e,JSON.stringify(r))];case 4:s.sent(),this.requestSsid(),s.label=5;case 5:return[2]}})})},this.requestSsid=function(){return __awaiter(e,void 0,void 0,function(){var e,n,t=this;return __generator(this,function(r){switch(r.label){case 0:return e=this.tokensKey,[4,StorageManager.get(e)];case 1:return n=r.sent(),fetch.fetch({url:REPORT_PREFIX+"/v1/user/ssid",method:"POST",data:JSON.stringify({app_id:this.appId,web_id:n.web_id,user_unique_id:""+n.user_unique_id}),header:{"Content-Type":"application/json; charset=utf-8"},success:function(r){return __awaiter(t,void 0,void 0,function(){var t,s;return __generator(this,function(i){switch(i.label){case 0:return this.unlock(),0===(t=JSON.parse(r.data)).e?[3,1]:(console.error("请求 ssid 失败~"),[3,3]);case 1:return this.envInfo.user.ssid=t.ssid,s=__assign({},n,{ssid:t.ssid}),[4,StorageManager.set(e,JSON.stringify(n))];case 2:i.sent(),console.warn("根据 user_unique_id 更新 ssid 成功！注意：在这之前不应该有数据被发出去"),this.callback&&this.callback(),i.label=3;case 3:return[2]}})})},fail:function(){t.unlock(),logger.error("根据 user_unique_id 获取新 ssid 失败")}}),[2]}})})},this.set=function(n,t){"os_version"===n&&(t+=""),"app_id"===n&&e.checkUserToken(t),"user_unique_id"===n&&e.verifyTokens(t),e.envInfo.user.hasOwnProperty(n)?"user_type"===n?(t=Number(t),e.envInfo.user[n]=Number(t)):"user_id"===n?(e.envInfo.user[n]=String(t),e.envInfo.user.user_unique_id=String(t)):e.envInfo.user[n]=String(t):e.envInfo.header.hasOwnProperty(n)?e.envInfo.header[n]=t:e.envInfo.header.headers.hasOwnProperty(n)?e.envInfo.header.headers[n]=t:e.envInfo.header.headers.custom[n]=t},this.get=function(){for(var n={user:{},header:{headers:{custom:{}}}},t=e.envInfo,r=t.user,s=0,i=Object.keys(r);s<i.length;s++)r[v=i[s]]!==undef&&(n.user[v]=r[v]);for(var o=t.header,a=0,u=Object.keys(o);a<u.length;a++)o[v=u[a]]!==undef&&"headers"!==v&&(n.header[v]=o[v]);for(var c=t.header.headers,f=0,h=Object.keys(c);f<h.length;f++)"custom"!==(v=h[f])&&c[v]!==undef&&(n.header.headers[v]=c[v]);var d=t.header.headers.custom,l=Object.keys(d);if(l.length)for(var g=0,_=l;g<_.length;g++){var v=_[g];n.header.headers.custom[v]=d[v]}else delete n.header.headers.custom;return{user:n.user,header:__assign({},n.header,{headers:JSON.stringify(n.header.headers)})}},this.envInfo={user:{user_id:undef,web_id:undef,user_unique_id:undef,ssid:undef,user_type:undef},header:{app_id:undef,app_name:undef,os_name:undef,os_version:undef,device_model:undef,ab_client:undef,ab_version:undef,traffic_type:undef,utm_source:undef,utm_medium:undef,utm_campaign:undef,headers:{platform:undef,sdk_version:undef,browser:undef,browser_version:undef,region:undef,province:undef,city:undef,language:undef,timezone:undef,tz_offset:undef,resolution:undef,screen_height:undef,screen_width:undef,referrer:undef,referrer_host:undef,custom:{}}}},this.isRequestWebId=!1,this.waitForVerifyTokens=!1,this.realUuid=""}return e.prototype.lock=function(){this.isUserTokensReady=!1},e.prototype.unlock=function(){this.isUserTokensReady=!0},e}(),env=new Env,MemoryCache=function(){function e(){var e=this;this.set=function(n,t){e.cache[n]=t},this.get=function(n){var t=[],r=e.cache[n];if(r)for(var s=0,i=r;s<i.length;s++){var o=i[s];t.push(o)}else t=[];return t},this.clean=function(n){e.cache[n]=void 0},this.cache={}}return e}(),mCacheManager=new MemoryCache,fetch$1=require("@system.fetch"),postData=function(e,n,t){var r=+new Date+Math.floor(1e5*Math.random());fetch$1.fetch({url:"https://mcs.snssdk.com/v1/list?tea_sdk_random="+r,data:e,method:"POST",header:{"Content-Type":"text/plain"},success:function(r){var s=r.data;try{s=JSON.parse(s)}catch(e){return logger.error("response反序列化错误"),void t()}"string"==typeof s?(logger.error("数据上报失败"),t()):(0===s.e?logger.warn("数据上报成功: ",e):(logger.error("数据上报失败！","错误码："+s.e),logger.error("为了避免后续上报数据被阻塞，sdk 将不再重试上报本数据，数据实体将会从 localstorage 清除")),n())},fail:function(){logger.error("数据上报失败"),t()}})},Channel=function(){function e(){var e=this;this.setReady=function(n){e.isReady=n,e.report()},this.setEvtParams=function(n){e.evtParams=__assign({},e.evtParams,n)},this.event=function(n){var t=e.cacheKey,r=mCacheManager.get(t)||[];r.push(n),mCacheManager.set(t,r),r.length>=5?e.report():setTimeout(function(){e.report()},45)},this.report=function(){return __awaiter(e,void 0,void 0,function(){var e,n,t,r,s,i,o,a;return __generator(this,function(u){switch(u.label){case 0:return this.isReady&&env.isUserTokensReady?(e=this.cacheKey,n=mCacheManager.get(e),mCacheManager.clean(e),t=this.mergeEvts(n),[4,StorageManager.get(e)]):[2,!1];case 1:return r=u.sent()||[],(s=t.concat(r)).length?(this.setSCcacheData(s),this.isReporting?[2,!1]:(i=s.length)?(o=0,a=null,i<=this.sliceLength?(o=i,a=s):(o=this.sliceLength,a=s.slice(i-this.sliceLength)),this.sendData(a,o),[2]):[2,!1]):[2,!1]}})})},this.sendData=function(n,t){e.isReporting=!0;var r=e.cacheKey;postData(n,function(){return __awaiter(e,void 0,void 0,function(){var e,n,s;return __generator(this,function(i){switch(i.label){case 0:return this.isReporting=!1,[4,StorageManager.get(r)];case 1:return e=i.sent()||[],n=e.length,s=e.slice(0,n-t),StorageManager.set(r,JSON.stringify(s)),this.report(),[2]}})})},function(){e.isReporting=!1,setTimeout(function(){e.report()},3e3)})},this.setSCcacheData=function(n){StorageManager.set(e.cacheKey,JSON.stringify(n))},this.mergeEvts=function(n){if(!n.length)return[];for(var t={events:[],user:{},header:{}},r=e.evtParams,s=Object.keys(r),i=0,o=n;i<o.length;i++){for(var a=o[i],u=0,c=s;u<c.length;u++){var f=c[u];void 0===a.params[f]&&(a.params[f]=r[f])}var h=JSON.stringify(a.params);a.params=h}t.events=n;var d=env.get();return t.events=n,t.user=d.user,t.header=d.header,[t]},this.isReady=!1,this.isReporting=!1,this.sliceLength=10,this.cacheKey=TEA_CACHE_PREFIX+"events",this.evtParams={}}return e}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},MiniProduct=function(){function e(){var e=this;this.getConfig=function(){return env.get()},this.init=function(e){if("number"!=typeof e)throw new Error("app_id must be a number");env.initDeviceInfo(),env.set("app_id",e)},this.config=function(n){if(e.channel.setReady(!1),"object"!==(void 0===n?"undefined":_typeof(n)))throw new Error("config param must be {}");n.log&&(logger.init(Boolean(n.log)),logger.info("logger 功能开启")),logger.info("当前配置项：",JSON.stringify(n,null,2));var t=Object.keys(n);if(!t.length)return!1;for(var r=0,s=t;r<s.length;r++){var i=s[r],o=n[i];"evtParams"===i?e.channel.setEvtParams(o):"_staging_flag"===i?(o+""=="1"&&logger.warn("根据_staging_flag设置，数据将会上报到stag 表。"),e.channel.setEvtParams({_staging_flag:o})):env.set(i,o)}},this.send=function(){env.isUserTokensReady?(logger.warn("看到本提示，意味着用户信息已完全就绪，上报通道打开"),logger.info("用户信息",JSON.stringify(env.get().user,null,2)),e.channel.setReady(!0)):e.callbackSend=!0},this.event=function(n,t){t||(t={}),"object"!==(void 0===t?"undefined":_typeof(t))&&logger.error("事件params 必须是{}:","event(event: string, params: object)");var r={event:n,params:t,local_time_ms:+new Date};e.channel.event(r)},this.callbackSend=!1,this.channel=new Channel,this.reportUrl="https://mcs.snssdk.com",env.callback=function(){e.callbackSend&&e.send()}}return e}(),index=new MiniProduct;module.exports=index;
