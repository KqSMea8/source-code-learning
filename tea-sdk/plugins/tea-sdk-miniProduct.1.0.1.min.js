"use strict";var __assign=function(){return(__assign=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++){n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e}).apply(this,arguments)},TEA_CACHE_PREFIX="__tea_cache_",REPORT_PREFIX="https://mcs.snssdk.com",StorageCache=function(){function e(){this.get=function(e){var n="";try{var t=wx.getStorageSync(e);t&&(n=t=JSON.parse(t))}catch(e){console.error(e.message)}return n},this.set=function(e,n){try{wx.setStorageSync(e,n)}catch(e){console.error(e)}}}return e}(),StorageManager=new StorageCache,prefix="tea-sdk:",Logger=function(){function e(){var e=this;this.init=function(n){e.isLog=n},this.info=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];e.isLog&&console.log.apply(console,[prefix].concat(n))},this.error=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];e.isLog&&(console.log(" "),console.error.apply(console,[prefix].concat(n)),console.log(" "))},this.warn=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];e.isLog&&console.warn.apply(console,[prefix].concat(n))},this.isLog=!1}return e}(),logger=new Logger,undef=void 0,Env=function(){function e(){var e=this;this.initDeviceInfo=function(){var n=e;wx&&wx.getSystemInfo&&wx.getSystemInfo({success:function(e){n.set("brand",e.brand),n.set("device_model",e.model),n.set("pixelRatio",e.pixelRatio),n.set("resolution",e.screenWidth+"x"+e.screenHeight),n.set("screen_width",e.screenWidth),n.set("screen_height",e.screenHeight),n.set("windowWidth",e.windowWidth),n.set("windowHeight",e.windowHeight),n.set("statusBarHeight",e.statusBarHeight),n.set("language",e.language),n.set("wx_version",e.version),n.set("os_version",e.system),n.set("os_name",e.platform),n.set("fontSizeSetting",e.fontSizeSetting),n.set("SDKVersion",e.SDKVersion),n.set("platform","miniProduct")}}),wx&&wx.getNetworkType&&wx.getNetworkType({success:function(e){n.set("networkType",e.networkType)}})},this.checkUserToken=function(n){e.appId=n;var t=TEA_CACHE_PREFIX+"tokens_"+n;e.tokensKey=t;var r=StorageManager.get(t);return r&&r.user_unique_id&&r.web_id&&r.ssid?(e.envInfo.user.user_unique_id=r.user_unique_id,e.envInfo.user.web_id=r.web_id,e.envInfo.user.ssid=r.ssid,console.warn("初始化已经检测到了 webid ssid user_id，一般情况下不需要再次验证 id 了"),e.unlock(),!1):e.requestWebId(n)},this.requestWebId=function(n){e.isRequestWebId=!0,wx.request({url:REPORT_PREFIX+"/v1/user/webid",method:"POST",data:{app_id:n,url:"location.href",user_agent:"navigator.userAgent",referer:"referer",user_unique_id:""},dataType:"json",header:{"Content-Type":"application/json; charset=utf-8"},success:function(n){var t=n.data;if(0!==t.e)console.error("请求 webid 失败~");else{e.isRequestWebId=!1,e.envInfo.user.ssid=t.ssid,e.envInfo.user.web_id=t.web_id,e.envInfo.user.user_unique_id=t.web_id;var r={web_id:t.web_id,ssid:t.ssid,user_unique_id:t.web_id};StorageManager.set(e.tokensKey,JSON.stringify(r)),e.waitForVerifyTokens?(e.lock(),e.verifyTokens(e.realUuid)):(e.unlock(),e.callback&&e.callback())}},fail:function(){e.isRequestWebId=!1,console.error("获取 webid 失败，数据将不会被上报")}})},this.verifyTokens=function(n){var t=e.tokensKey;if(e.waitForVerifyTokens=!1,e.realUuid=""+n,e.isRequestWebId)return e.waitForVerifyTokens=!0,console.warn("正在请求 webid，requestSsid 将会在前者请求完毕之后被调用"),!1;var r=StorageManager.get(t);if(r.user_unique_id===e.realUuid&&r.ssid&&r.web_id)console.warn("用户身份验证完毕：",JSON.stringify(r,null,2)),console.warn("传入的 user_id/user_unique_id 与 缓存中的完全一致，无需再次请求"),e.unlock();else{e.lock(),e.envInfo.user.user_unique_id=e.realUuid;var s=__assign({},StorageManager.get(t),{user_unique_id:e.realUuid});StorageManager.set(t,JSON.stringify(s)),e.requestSsid()}},this.requestSsid=function(){var n=e.tokensKey,t=StorageManager.get(n);wx.request({url:REPORT_PREFIX+"/v1/user/ssid",method:"POST",data:{app_id:e.appId,web_id:t.web_id,user_unique_id:""+t.user_unique_id},success:function(r){e.unlock();var s=r.data;if(0!==s.e)console.error("请求 ssid 失败~");else{e.envInfo.user.ssid=s.ssid;var i=__assign({},t,{ssid:s.ssid});StorageManager.set(n,JSON.stringify(i)),console.warn("根据 user_unique_id 更新 ssid 成功！注意：在这之前不应该有数据被发出去"),e.callback&&e.callback()}},fail:function(){e.unlock(),logger.error("根据 user_unique_id 获取新 ssid 失败")}})},this.set=function(n,t){"os_version"===n&&(t+=""),"app_id"===n&&e.checkUserToken(t),"user_unique_id"===n&&e.verifyTokens(t),e.envInfo.user.hasOwnProperty(n)?"user_type"===n?(t=Number(t),e.envInfo.user[n]=Number(t)):"user_id"===n?(e.envInfo.user[n]=String(t),e.envInfo.user.user_unique_id=String(t)):e.envInfo.user[n]=String(t):e.envInfo.header.hasOwnProperty(n)?e.envInfo.header[n]=t:e.envInfo.header.headers.hasOwnProperty(n)?e.envInfo.header.headers[n]=t:e.envInfo.header.headers.custom[n]=t},this.get=function(){for(var n={user:{},header:{headers:{custom:{}}}},t=e.envInfo,r=t.user,s=0,i=Object.keys(r);s<i.length;s++)r[_=i[s]]!==undef&&(n.user[_]=r[_]);for(var o=t.header,a=0,u=Object.keys(o);a<u.length;a++)o[_=u[a]]!==undef&&"headers"!==_&&(n.header[_]=o[_]);for(var c=t.header.headers,d=0,f=Object.keys(c);d<f.length;d++)"custom"!==(_=f[d])&&c[_]!==undef&&(n.header.headers[_]=c[_]);var g=t.header.headers.custom,h=Object.keys(g);if(h.length)for(var l=0,v=h;l<v.length;l++){var _=v[l];n.header.headers.custom[_]=g[_]}else delete n.header.headers.custom;return{user:n.user,header:__assign({},n.header,{headers:JSON.stringify(n.header.headers)})}},this.envInfo={user:{user_id:undef,web_id:undef,user_unique_id:undef,ssid:undef,user_type:undef},header:{app_id:undef,app_name:undef,os_name:undef,os_version:undef,device_model:undef,ab_client:undef,ab_version:undef,traffic_type:undef,utm_source:undef,utm_medium:undef,utm_campaign:undef,headers:{platform:undef,sdk_version:undef,browser:undef,browser_version:undef,region:undef,province:undef,city:undef,language:undef,timezone:undef,tz_offset:undef,resolution:undef,screen_height:undef,screen_width:undef,referrer:undef,referrer_host:undef,custom:{}}}},this.initDeviceInfo(),this.isRequestWebId=!1,this.waitForVerifyTokens=!1,this.realUuid=""}return e.prototype.lock=function(){this.isUserTokensReady=!1},e.prototype.unlock=function(){this.isUserTokensReady=!0},e}(),env=new Env,MemoryCache=function(){function e(){var e=this;this.set=function(n,t){e.cache[n]=t},this.get=function(n){var t=[],r=e.cache[n];if(r)for(var s=0,i=r;s<i.length;s++){var o=i[s];t.push(o)}else t=[];return t},this.clean=function(n){e.cache[n]=void 0},this.cache={}}return e}(),mCacheManager=new MemoryCache,postData=function(e,n,t){var r=+new Date+Math.floor(1e5*Math.random());wx.request({url:"https://mcs.snssdk.com/v1/list?tea_sdk_random="+r,data:e,method:"POST",dataType:"json",header:{"Content-Type":"text/plain"},success:function(r){var s=r&&r.data;"string"==typeof s?(logger.error("数据上报失败"),t()):(0===s.e?logger.warn("数据上报成功: ",e):(logger.error("数据上报失败！","错误码："+s.e),logger.error("为了避免后续上报数据被阻塞，sdk 将不再重试上报本数据，数据实体将会从 localstorage 清除")),n())},fail:function(){logger.error("数据上报失败"),t()}})},Channel=function(){function e(){var e=this;this.setReady=function(n){e.isReady=n,e.report()},this.setEvtParams=function(n){e.evtParams=__assign({},e.evtParams,n)},this.event=function(n){var t=e.cacheKey,r=mCacheManager.get(t)||[];r.push(n),mCacheManager.set(t,r),r.length>=5?e.report():setTimeout(function(){e.report()},45)},this.report=function(){if(!e.isReady)return!1;if(!env.isUserTokensReady)return!1;var n=e.cacheKey,t=mCacheManager.get(n);mCacheManager.clean(n);var r=e.mergeEvts(t),s=StorageManager.get(n)||[],i=r.concat(s);if(!i.length)return!1;if(e.setSCcacheData(i),e.isReporting)return!1;var o=i.length;if(!o)return!1;var a=0,u=null;o<=e.sliceLength?(a=o,u=i):(a=e.sliceLength,u=i.slice(o-e.sliceLength)),e.sendData(u,a)},this.sendData=function(n,t){e.isReporting=!0;var r=e.cacheKey;postData(n,function(){e.isReporting=!1;var n=StorageManager.get(r),s=n.length,i=n.slice(0,s-t);StorageManager.set(r,JSON.stringify(i)),e.report()},function(){e.isReporting=!1,setTimeout(function(){e.report()},3e3)})},this.setSCcacheData=function(n){StorageManager.set(e.cacheKey,JSON.stringify(n))},this.mergeEvts=function(n){if(!n.length)return[];for(var t={events:[],user:{},header:{}},r=e.evtParams,s=Object.keys(r),i=0,o=n;i<o.length;i++){for(var a=o[i],u=0,c=s;u<c.length;u++){var d=c[u];void 0===a.params[d]&&(a.params[d]=r[d])}var f=JSON.stringify(a.params);a.params=f}t.events=n;var g=env.get();return t.events=n,t.user=g.user,t.header=g.header,[t]},this.isReady=!1,this.isReporting=!1,this.sliceLength=10,this.cacheKey=TEA_CACHE_PREFIX+"events",this.evtParams={}}return e}(),enterTime,mpEnter=function(e,n){enterTime=+new Date,e("mp_enter",__assign({},n))},mpExit=function(e,n){void 0===n&&(n={});var t=getCurrentPages(),r=t[t.length-1].route,s=void 0===enterTime?0:+new Date-enterTime;e("mp_exit",__assign({duration:s,page_path:r},n)),enterTime=void 0},purchase=function(e,n){e("purchase",__assign({},n))},quest=function(e,n){e("quest",__assign({},n))},updateLevel=function(e,n){e("update_level",__assign({},n))},createGameRole=function(e,n){e("create_gamerole",__assign({},n))},checkout=function(e,n){e("check_out",__assign({},n))},addToFavourite=function(e,n){e("add_to_favourite",__assign({},n))},predefineEvents=Object.freeze({mpEnter:mpEnter,mpExit:mpExit,purchase:purchase,quest:quest,updateLevel:updateLevel,createGameRole:createGameRole,checkout:checkout,addToFavourite:addToFavourite}),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};if(!wx)throw new Error("本 sdk 的运行环境只能是微信小程序！");var MiniProduct=function(){function e(){var e=this;this.addPredefinedEvent=function(){for(var n in predefineEvents)e[n]=predefineEvents[n].bind(null,e.event)},this.getConfig=function(){return env.get()},this.init=function(e){if("number"!=typeof e)throw new Error("app_id must be a number");env.set("app_id",e)},this.config=function(n){if(e.channel.setReady(!1),"object"!==(void 0===n?"undefined":_typeof(n)))throw new Error("config param must be {}");n.log&&(logger.init(Boolean(n.log)),logger.info("logger 功能开启")),logger.info("当前配置项：",JSON.stringify(n,null,2));var t=Object.keys(n);if(!t.length)return!1;for(var r=0,s=t;r<s.length;r++){var i=s[r],o=n[i];"evtParams"===i?e.channel.setEvtParams(o):"_staging_flag"===i?(o+""=="1"&&logger.warn("根据_staging_flag设置，数据将会上报到stag 表。"),e.channel.setEvtParams({_staging_flag:o})):env.set(i,o)}},this.send=function(){env.isUserTokensReady?(logger.warn("看到本提示，意味着用户信息已完全就绪，上报通道打开"),logger.info("用户信息",JSON.stringify(env.get().user,null,2)),e.channel.setReady(!0)):e.callbackSend=!0},this.event=function(n,t){t||(t={}),"object"!==(void 0===t?"undefined":_typeof(t))&&logger.error("事件params 必须是{}:","event(event: string, params: object)");var r={event:n,params:t,local_time_ms:+new Date};e.channel.event(r)},this.callbackSend=!1,this.channel=new Channel,this.reportUrl="https://mcs.snssdk.com",env.callback=function(){e.callbackSend&&e.send()},this.addPredefinedEvent()}return e}(),index=new MiniProduct;module.exports=index;
