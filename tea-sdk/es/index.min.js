function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function getVersion(e,n){var r=e.exec(n);return r&&r[1]?r[1]:""}function getAndroidVersion(e){var n=getVersion(/Android ([\.\_\d]+)/,e);return n||(n=getVersion(/Android\/([\.\_\d]+)/,e)),n}function _classCallCheck$1(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function isSupportLS(){try{return localStorage.setItem("_____tea-sdk-test-key","hi"),localStorage.getItem("_____tea-sdk-test-key"),localStorage.removeItem("_____tea-sdk-test-key"),!0}catch(e){return!1}}function _classCallCheck$2(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$3(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$4(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function _inherits(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}function _classCallCheck$5(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function decrypto(e,n,r){if("string"==typeof e&&"number"==typeof n&&"number"==typeof r){var t=[],o=[];r=r<=25?r:r%25;var i=String.fromCharCode(r+97);t=e.split(i);for(var s=0;s<t.length;s++){var a=parseInt(t[s],r);a=1*a^n;var c=String.fromCharCode(a);o.push(c)}return o.join("")}}function b(e){return e?(e^16*Math.random()>>e/4).toString(10):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,b)}function _classCallCheck$6(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$1(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function _inherits$1(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}function _classCallCheck$7(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$8(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$9(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$2(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function _inherits$2(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}function _classCallCheck$a(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$b(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _extends=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var r=arguments[n];for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])}return e},undef=void 0,Env=function e(){var n=this;_classCallCheck(this,e),this.set=function(e,r){var t=e,o=r;if(null===o)return!1;var i="";if(t.indexOf(".")>-1){var s=t.split(".");i=s[0],t=s[1]}"os_version"===t&&(o=""+o),i?"user"===i||"header"===i?n.envInfo[i][t]=o:"headers"===i?n.envInfo.header.headers[t]=o:n.envInfo.header.headers.custom[t]=o:n.envInfo.user.hasOwnProperty(t)?["user_type","device_id","ip_addr_id"].indexOf(t)>-1?n.envInfo.user[t]=Number(o):["user_id","web_id","user_unique_id","ssid"].indexOf(t)>-1?n.envInfo.user[t]=String(o):["user_is_auth","user_is_login"].indexOf(t)>-1&&(n.envInfo.user[t]=Boolean(o)):n.envInfo.header.hasOwnProperty(t)?n.envInfo.header[t]=o:n.envInfo.header.headers.hasOwnProperty(t)?n.envInfo.header.headers[t]=o:n.envInfo.header.headers.custom[t]=o},this.get=function(){for(var e={user:{},header:{headers:{custom:{}}}},r=n.envInfo,t=r.user,o=Object.keys(t),i=Array.isArray(o),s=0,o=i?o:o[Symbol.iterator]();;){var a;if(i){if(s>=o.length)break;a=o[s++]}else{if((s=o.next()).done)break;a=s.value}var c=a;t[c]!==undef&&(e.user[c]=t[c])}for(var u=r.header,l=Object.keys(u),d=Array.isArray(l),f=0,l=d?l:l[Symbol.iterator]();;){var _;if(d){if(f>=l.length)break;_=l[f++]}else{if((f=l.next()).done)break;_=f.value}var p=_;u[p]!==undef&&"headers"!==p&&(e.header[p]=u[p])}for(var h=r.header.headers,g=Object.keys(h),v=Array.isArray(g),m=0,g=v?g:g[Symbol.iterator]();;){var b;if(v){if(m>=g.length)break;b=g[m++]}else{if((m=g.next()).done)break;b=m.value}var y=b;"custom"!==y&&h[y]!==undef&&(e.header.headers[y]=h[y])}var w=r.header.headers.custom,C=Object.keys(w);if(C.length)for(var k=C,O=Array.isArray(k),S=0,k=O?k:k[Symbol.iterator]();;){var E;if(O){if(S>=k.length)break;E=k[S++]}else{if((S=k.next()).done)break;E=S.value}var I=E;e.header.headers.custom[I]=w[I]}return{user:e.user,header:_extends({},e.header,{headers:e.header.headers})}},this.envInfo={user:{user_unique_id:undef,user_type:undef,user_id:undef,user_is_auth:undef,user_is_login:undef,device_id:undef,web_id:undef,ip_addr_id:undef,ssid:undef},header:{app_id:undef,app_name:undef,app_install_id:undef,app_package:undef,app_channel:undef,app_version:undef,os_name:undef,os_version:undef,device_model:undef,ab_client:undef,ab_version:undef,traffic_type:undef,utm_source:undef,utm_medium:undef,utm_campaign:undef,client_ip:undef,device_brand:undef,os_api:undef,access:undef,language:undef,region:undef,app_language:undef,app_region:undef,creative_id:undef,ad_id:undef,campaign_id:undef,log_type:undef,rnd:undef,platform:undef,sdk_version:undef,province:undef,city:undef,timezone:undef,tz_offset:undef,tz_name:undef,sim_region:undef,carrier:undef,resolution:undef,browser:undef,browser_version:undef,referrer:undef,referrer_host:undef,headers:{utm_term:undef,utm_content:undef,custom:{}}}}},parseURL=function(e){var n=document.createElement("a");return n.href=e,n},parseUrlQuery=function(e){var n=parseURL(e).search,r={};return(n=n.slice(1)).split("&").forEach(function(e){var n=e.split("="),t=n[0],o=n[1];r[t]=decodeURIComponent(void 0===o?"":o)}),r},undef$1="",screen_width=screen.width||0,screen_height=screen.height||0,screen_size=screen_width+" x "+screen_height,appVersion=navigator.appVersion,userAgent=navigator.userAgent,language=navigator.language,referrer=document.referrer,referrer_host=parseURL(referrer).hostname,urlQueryObj=parseUrlQuery(location.href),os_name=undef$1,os_version=undef$1,browser="",browser_version=""+parseFloat(appVersion),versionOffset=void 0,semiIndex=void 0;-1!==(versionOffset=userAgent.indexOf("Opera"))&&(browser="Opera",browser_version=userAgent.substring(versionOffset+6),-1!==(versionOffset=userAgent.indexOf("Version"))&&(browser_version=userAgent.substring(versionOffset+8))),-1!==(versionOffset=userAgent.indexOf("Edge"))?(browser="Microsoft Edge",browser_version=userAgent.substring(versionOffset+5)):-1!==(versionOffset=userAgent.indexOf("MSIE"))?(browser="Microsoft Internet Explorer",browser_version=userAgent.substring(versionOffset+5)):-1!==(versionOffset=userAgent.indexOf("Chrome"))?(browser="Chrome",browser_version=userAgent.substring(versionOffset+7)):-1!==(versionOffset=userAgent.indexOf("Safari"))?(browser="Safari",browser_version=userAgent.substring(versionOffset+7),-1!==(versionOffset=userAgent.indexOf("Version"))&&(browser_version=userAgent.substring(versionOffset+8))):-1!==(versionOffset=userAgent.indexOf("Firefox"))&&(browser="Firefox",browser_version=userAgent.substring(versionOffset+8)),-1!==(semiIndex=browser_version.indexOf(";"))&&(browser_version=browser_version.substring(0,semiIndex)),-1!==(semiIndex=browser_version.indexOf(" "))&&(browser_version=browser_version.substring(0,semiIndex)),-1!==(semiIndex=browser_version.indexOf(")"))&&(browser_version=browser_version.substring(0,semiIndex));for(var platform=/Mobile|htc|mini|Android|iP(ad|od|hone)/.test(appVersion)?"wap":"web",clientOpts=[{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Android",r:/Android/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/}],i=0;i<clientOpts.length;i++){var cs=clientOpts[i];if(cs.r.test(userAgent)){os_name=cs.s;break}}switch(/Windows/.test(os_name)&&(os_version=getVersion(/Windows (.*)/,os_name),os_name="windows"),os_name){case"Mac OS X":os_version=getVersion(/Mac OS X (10[\.\_\d]+)/,userAgent),os_name="mac";break;case"Android":os_version=getAndroidVersion(userAgent),os_name="android";break;case"iOS":os_version=(os_version=/OS (\d+)_(\d+)_?(\d+)?/.exec(appVersion))?os_version[1]+"."+os_version[2]+"."+(0|os_version[3]):"",os_name="ios"}var browser$1={screen_size:screen_size,browser:browser,browser_version:browser_version,platform:platform,os_name:os_name,os_version:os_version,userAgent:userAgent,screen_width:screen_width,screen_height:screen_height,device_model:os_name,language:language,referrer:referrer,referrer_host:referrer_host,utm_source:urlQueryObj.utm_source,utm_medium:urlQueryObj.utm_medium,utm_campaign:urlQueryObj.utm_campaign,utm_term:urlQueryObj.utm_term,utm_content:urlQueryObj.utm_content},MemoryCache=function e(){var n=this;_classCallCheck$1(this,e),this.setItem=function(e,r){n.cache[e]=r},this.getItem=function(e){return n.cache[e]},this.removeItem=function(e){n.cache[e]=void 0},this.clear=function(){n.cache={}},this.cache={}};new MemoryCache;var StorageCache={getItem:function(e){try{var n=localStorage.getItem(e),r=n;try{n&&"string"==typeof n&&(r=JSON.parse(n))}catch(e){}return r||void 0}catch(e){}},setItem:function(e,n){try{var r="string"==typeof n?n:JSON.stringify(n);localStorage.setItem(e,r)}catch(e){}},removeItem:function(e){try{localStorage.removeItem(e)}catch(e){}},clear:function(){try{localStorage.clear()}catch(e){}},isSupportLS:isSupportLS()},StorageClient=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];_classCallCheck$2(this,e);var r=!n&&StorageCache.isSupportLS;this._storage=r?StorageCache:new MemoryCache}return e.prototype.getItem=function(e){return this._storage.getItem(e)},e.prototype.setItem=function(e,n){this._storage.setItem(e,n)},e.prototype.removeItem=function(e){this._storage.removeItem(e)},e.prototype.clear=function(){this._storage.clear()},e}(),TEA_CACHE_PREFIX="__tea_cache_",TEA_LOGGER_PREFIX="[tea-sdk]",ERROR_CODE={NO_URL_PREFIX:4001,IMG_ON_ERROR:4e3,IMG_CATCH_ERROR:4002,BEACON_STATUS_FALSE:4003,XHR_ON_ERROR:500,RESPONSE_DATA_ERROR:5001},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Logger=function e(){var n=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";_classCallCheck$3(this,e),this.init=function(e){n.isLog=e},this.info=function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),o=1;o<r;o++)t[o-1]=arguments[o];if(n.isLog){var i;(i=console).log.apply(i,[n.prefix+e].concat(t))}},this.warn=function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),o=1;o<r;o++)t[o-1]=arguments[o];if(n.isLog){var i;(i=console).warn.apply(i,[n.prefix+e].concat(t))}},this.error=function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),o=1;o<r;o++)t[o-1]=arguments[o];if(n.isLog){var i;(i=console).error.apply(i,[n.prefix+e].concat(t))}},this.dir=function(){if(n.isLog){var e;(e=console).dir.apply(e,arguments)}},this.table=function(e){n.isLog&&console.table(e)},this.logJSON=function(e){"object"===(void 0===e?"undefined":_typeof(e))&&n.isLog&&n.info("",JSON.stringify(e,null,2))},this.deprecated=function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),o=1;o<r;o++)t[o-1]=arguments[o];n.warn.apply(n,["[DEPRECATED]"+e].concat(t))},this.throw=function(e){throw n.error(n.prefix),new Error(e)};var t=r?"["+r+"]":"";this.prefix=TEA_LOGGER_PREFIX+t},logger=new Logger,fetchTokens=function(e,n,r,t){var o=new XMLHttpRequest;o.open("POST",e,!0),o.setRequestHeader("Content-Type","application/json; charset=utf-8"),o.onload=function(){try{var e=JSON.parse(o.responseText);r&&r(e)}catch(e){t&&t()}},o.onerror=function(){t&&t()},o.send(JSON.stringify(n))},date=new Date,timeZoneMin=date.getTimezoneOffset(),timezone=parseInt(-timeZoneMin/60,10),tz_offset=60*timeZoneMin,sdk_version=void 0;try{sdk_version="3.2.9"}catch(e){sdk_version="2.x"}var ClientEnv=function(e){function n(){_classCallCheck$4(this,n);var r=_possibleConstructorReturn(this,e.call(this));return r.initClientEnv=function(){r.set("os_name",browser$1.os_name),r.set("os_version",browser$1.os_version),r.set("device_model",browser$1.device_model),r.set("platform",browser$1.platform),r.set("sdk_version",sdk_version),r.set("browser",browser$1.browser),r.set("browser_version",browser$1.browser_version),r.set("language",browser$1.language),r.set("timezone",timezone),r.set("tz_offset",tz_offset),r.set("resolution",browser$1.screen_width+"x"+browser$1.screen_height),r.set("screen_width",browser$1.screen_width),r.set("screen_height",browser$1.screen_height),r.set("referrer",browser$1.referrer),r.set("referrer_host",browser$1.referrer_host),r.set("utm_source",browser$1.utm_source),r.set("utm_medium",browser$1.utm_medium),r.set("utm_campaign",browser$1.utm_campaign),r.set("utm_term",browser$1.utm_term),r.set("utm_content",browser$1.utm_content)},r.initClientEnv(),r}return _inherits(n,e),n}(Env),clientEnvManager=new ClientEnv,Type=function(){function e(){_classCallCheck$5(this,e)}return e.prototype.isString=function(e){return"String"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isNumber=function(e){return"Number"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isBoolean=function(e){return"Boolean"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isFunction=function(e){return"Function"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isNull=function(e){return"Null"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isUndefined=function(e){return"Undefined"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isObj=function(e){return"Object"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isArray=function(e){return"Array"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isFalse=function(e){return""===e||void 0===e||null===e||"null"===e||"undefined"===e||0===e||!1===e||NaN===e},e.prototype.isTrue=function(e){return!this.isFalse(e)},e.prototype.isLowIE=function(){return window.XDomainRequest},e}(),types=new Type,decodeXXX=function(e){return decrypto(e,64,25)},webid=function(){return b().replace(/-/g,"").slice(0,19)},_extends$1=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var r=arguments[n];for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])}return e},urlPrefix={cn:"1fz22z22z1nz21z4mz4bz4bz1kz1az21z4az21z1lz21z21z1bz1iz4az1az1mz1k",sg:"1fz22z22z1nz21z4mz4bz4bz21z1ez18z1jz1gz49z1kz1az21z4az19z27z22z1cz1mz24z1cz20z21z1cz18z4az1az1mz1k",va:"1fz22z22z1nz21z4mz4bz4bz1kz18z1jz1gz24z18z49z1kz1az21z4az19z27z22z1cz1mz24z1cz20z21z1cz18z4az1az1mz1k"},getCookie=function(e){try{var n=document.cookie.match(new RegExp("(?:^|;)\\s*"+e+"=([^;]+)"));return decodeURIComponent(n?n[1]:"")}catch(e){return""}},AppChannelEnv=function(e){function n(){_classCallCheck$6(this,n);var r=_possibleConstructorReturn$1(this,e.call(this));return r.init=function(e){var n=e.app_id,t=e.channel,o=e.log,i=e.channel_domain,s=e.name;if("number"!=typeof n)throw new Error("app_id 必须是一个数字，注意检查是否是以`string`的方式传入的？");r.logger=new Logger(s),r.logger.init(o),r.initConfigs(e),r.initUrls(t,i),r.setEnv("app_id",n)},r.initConfigs=function(e){var n=e.app_id,t=e.disable_ssid,o=e.disable_webid,i=e.disable_sdk_monitor;r.app_id=n,r.evtDataCacheKey=TEA_CACHE_PREFIX+"events_"+n,t&&(r.logger.info("ssid已禁用，设置user_unique_id不会请求ssid接口。"),r.isSsidDisabled=!0),o&&(r.logger.info("webid服务已禁用，ssid同时被禁用。将本地生成webid。"),r.isWebidDisabled=!0,r.isSsidDisabled=!0),i&&(r.logger.info("SDK监控已禁用。"),r.isSdkMonitorDisabled=!0)},r.initUrls=function(e,n){if("internal"===e&&(r.logger.warn("channel 的值 internal 已被废弃，已自动改为 cn。"),e="cn"),!n&&!urlPrefix[e])throw new Error("channel 变量只能是 `cn`, `sg`,`va`");var t=n||decodeXXX(urlPrefix[e]);t=t.replace(/\/+$/,""),r.reportUrl=t+"/v1/list",r.userTokensPrefix=""+t},r.setEnv=function(e,n){if("app_id"===e&&r.checkUserToken(n),"user_unique_id"===e){if(r.blackUuid.some(function(e){return e===String(n)}))return void r.logger.warn('设置了无效的值 {user_unique_id："%s"}。该操作已忽略。',n);r.verifyTokens(n)}if("web_id"===e){if(!n)return;(!r.envInfo.user.user_unique_id||r.envInfo.user.user_unique_id&&r.envInfo.user.user_unique_id===r.envInfo.user.web_id)&&r.set("user_unique_id",n)}r.set(e,n)},r.transferFromCookie=function(){var e=r.tokensCacheKey,n=getCookie("tt_webid"),t=getCookie("__tea_sdk__ssid"),o=getCookie("__tea_sdk__user_unique_id");if(types.isLowIE()){if(n){var i={web_id:n,ssid:n,user_unique_id:n};r.storageClient.setItem(e,i)}return!1}if(n&&t&&o){var s={web_id:n,ssid:t,user_unique_id:o};r.storageClient.setItem(e,s)}},r.purifyBlackUuid=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(r.blackUuid.some(function(n){return n===e.user_unique_id})){var n={};return r.setUserTokens(n),r.logger.warn('检测到无效的用户标识，已重置用户状态。{user_unique_id: "%s"}',e.user_unique_id),n}return e},r.getUserTokens=function(){return r.storageClient.getItem(r.tokensCacheKey)||{}},r.setUserTokens=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r.storageClient.setItem(r.tokensCacheKey,e)},r.checkUserToken=function(e){var n=TEA_CACHE_PREFIX+"tokens_"+e;r.tokensCacheKey=n,r.transferFromCookie();var t=r.purifyBlackUuid(r.getUserTokens());t.user_unique_id&&t.web_id?(r.envInfo.user.user_unique_id=t.user_unique_id,r.envInfo.user.web_id=t.web_id,r.envInfo.user.ssid=t.ssid||"",r.logger.info("初始化已经检测到了 webid user_unique_id，一般情况下不需要再次验证 id 了"),r.unlock()):r.requestWebId(e)},r.saveTokenToStorage=function(e){var n=e.web_id,t=e.ssid,o=e.user_unique_id;r.setUserTokens({web_id:n,ssid:t,user_unique_id:o})},r.requestWebId=function(){r.isRequestWebId=!0;var e=function(e){var n=r.envInfo.user.web_id||e.web_id,t=e.ssid;r.isRequestWebId=!1,r.envInfo.user.ssid=t,r.envInfo.user.web_id=n,r.envInfo.user.user_unique_id=n,r.saveTokenToStorage({web_id:n,ssid:t,user_unique_id:n}),r.waitForVerifyTokens?(r.lock(),r.verifyTokens(r.realUuid)):(r.unlock(),r.callback&&r.callback())};r.isWebidDisabled?function(){e({web_id:webid(),ssid:""})}():function(){var n=r.userTokensPrefix+"/v1/user/webid";fetchTokens(n,{app_id:r.app_id,url:location.href,user_agent:browser$1.userAgent,referer:browser$1.referrer,user_unique_id:""},function(n){0!==n.e?r.logger.error("请求 webid 失败。请联系管理员。"):e(n)},function(){r.isRequestWebId=!1,r.logger.error("获取 webid 失败，数据将不会被上报")})}()},r.verifyTokens=function(e){var n=r.tokensCacheKey;if(r.waitForVerifyTokens=!1,r.realUuid=""+e,r.isRequestWebId)return r.waitForVerifyTokens=!0,r.logger.info("正在请求 webid，requestSsid 将会在前者请求完毕之后被调用"),!1;var t=r.getUserTokens();if(t.user_unique_id===r.realUuid&&t.ssid&&t.web_id)r.logger.info("传入的 user_id/user_unique_id 与 缓存中的完全一致，无需再次请求"),r.unlock();else{r.lock(),r.envInfo.user.user_unique_id=r.realUuid;var o=_extends$1({},r.getUserTokens(),{user_unique_id:r.realUuid});if(r.storageClient.setItem(n,o),types.isLowIE())return r.unlock(),!1;r.isSsidDisabled?(r.unlock(),r.callback&&r.callback()):r.requestSsid()}},r.requestSsid=function(){var e=r.getUserTokens(),n=r.userTokensPrefix+"/v1/user/ssid";fetchTokens(n,{app_id:r.app_id,web_id:e.web_id,user_unique_id:""+e.user_unique_id},function(n){if(r.unlock(),0!==n.e)r.logger.error("请求 ssid 失败~");else{r.envInfo.user.ssid=n.ssid;var t=_extends$1({},e,{ssid:n.ssid});r.setUserTokens(t),r.logger.info("根据 user_unique_id 更新 ssid 成功！注意：在这之前不应该有数据被发出去"),r.callback&&r.callback()}},function(){r.unlock(),r.logger.error("根据 user_unique_id 获取新 ssid 失败")})},r.setEvtParams=function(e){var n=_extends$1({},e);Object.keys(n).forEach(function(e){r.evtParams[e]=n[e]})},r.mergeEnvToEvents=function(e){var n=r.mergeEnv(),t=[],o=0,i=void 0;return e.forEach(function(e){var n=!!e.params.__disable_storage__;void 0===i?i=n:(n!==i||t[o].length>=5)&&(o+=1,i=!i),t[o]=t[o]||[],t[o].push(e)}),t.map(function(e){return{events:e.map(function(e){var n=_extends$1({},r.evtParams,e.params);return delete n.__disable_storage__,_extends$1({},e,{params:JSON.stringify(n)})}),user:n.user,header:n.header,verbose:r.debugMode?1:void 0,__disable_storage__:e[0].params.__disable_storage__}})},r.mergeEnv=function(){var e=r.get(),n=clientEnvManager.get(),t=_extends$1({},e.user),o=_extends$1({},n.header.headers.custom,e.header.headers.custom),i=_extends$1({},n.header.headers,e.header.headers,{custom:o}),s=_extends$1({},n.header,e.header);return{user:t,header:_extends$1({},s,{headers:JSON.stringify(i)})}},r.evtParams={},r.reportUrl="",r.userTokensPrefix="",r.isSsidDisabled=!1,r.isWebidDisabled=!1,r.isSdkMonitorDisabled=!1,r.debugMode=!1,r.blackUuid=["null","undefined","0","","None"],r.logger=function(){},r.storageClient=new StorageClient,r}return _inherits$1(n,e),n.prototype.lock=function(){this.isUserTokensReady=!1},n.prototype.unlock=function(){this.isUserTokensReady=!0},n.prototype.enableDebugMode=function(e){this.debugMode=e},n}(Env),EventStorageManager=function(){function e(n){var r=n.disable_storage,t=void 0!==r&&r;_classCallCheck$7(this,e),this._storage=new StorageClient(t),this._storageKey="",this._data=void 0}return e.prototype.setStorageKey=function(e){this._storageKey=e},e.prototype.getAllEvents=function(){var e=this.getData();Object.keys(e).reduce(function(n,r){return n.concat(e[r]||[])},[])},e.prototype.getData=function(){return this._checkIsDataInit(),this._data},e.prototype.add=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this._checkIsDataInit(),0!==n.length&&(this._data[e]=n,this._save())},e.prototype.delete=function(e){this._checkIsDataInit(),this._data[e]&&(delete this._data[e],this._save())},e.prototype._checkIsDataInit=function(){if(void 0===this._data)try{var e=this._getDataFromStorage();if(types.isArray(e)){var n;this._data=(n={},n[webid()]=e,n),this._save()}else this._data=e}catch(e){this._data={}}},e.prototype._checkStorageKey=function(){if(!this._storageKey)throw new Error("must call setStorageKey('xxx') first")},e.prototype._getDataFromStorage=function(){return this._checkStorageKey(),this._storage.getItem(this._storageKey)||{}},e.prototype._save=function(){this._checkStorageKey(),this._storage.setItem(this._storageKey,this._data)},e}(),encodePayload=function(e){var n="";for(var r in e)e.hasOwnProperty(r)&&(n+="&"+r+"="+encodeURIComponent(JSON.stringify(e[r])));return n="&"===n[0]?n.slice(1):n},sendByImg=function(e,n){try{var r=e.split("v1")[0];n.forEach(function(e){var n=encodePayload(e),t=new Image(1,1);t.onload=function(){t=null},t.onerror=function(){t=null},t.src=r+"/v1/gif?"+n})}catch(e){}},postSdkLog=function(e,n){if(window.XDomainRequest)return sendByImg(e,n);var r=new XMLHttpRequest;r.open("POST",e+"?rdn="+Math.random(),!0),r.onload=function(){},r.onerror=function(){r.abort()},r.send(JSON.stringify(n))},encodePayload$1=function(e){var n="";for(var r in e)e.hasOwnProperty(r)&&(n+="&"+r+"="+encodeURIComponent(JSON.stringify(e[r])));return n="&"===n[0]?n.slice(1):n},sendByImg$1=function(e,n,r,t){try{var o=e.split("v1")[0];if(!o)return void t(e,n,ERROR_CODE.NO_URL_PREFIX);n.forEach(function(i){var s=encodePayload$1(i),a=new Image(1,1);a.onload=function(){a=null,r()},a.onerror=function(){a=null,t(e,n,ERROR_CODE.IMG_ON_ERROR)},a.src=o+"/v1/gif?"+s})}catch(r){t(e,n,ERROR_CODE.IMG_CATCH_ERROR,r.message)}},request=function(e){var n=e.url,r=e.data,t=e.success,o=e.fail,i=e.notSure,s=e.isUnload,a=r;if(window.XDomainRequest)return void sendByImg$1(n,a,t,o);if(s)return window.navigator&&window.navigator.sendBeacon?(i(),void(window.navigator.sendBeacon(n,JSON.stringify(a))?t():o(n,r,ERROR_CODE.BEACON_STATUS_FALSE))):void sendByImg$1(n,a,t,o);var c=new XMLHttpRequest;c.open("POST",n+"?rdn="+Math.random(),!0),c.onload=function(){t(n,a,c.responseText)},c.onerror=function(){c.abort(),o(n,a,ERROR_CODE.XHR_ON_ERROR)},c.send(JSON.stringify(a))},EventSender=function e(n){var r=this;_classCallCheck$8(this,e),this.send=function(e){var n=e.url,t=e.data,o=e.success,i=e.fail,s=e.eventError,a=e.notSure,c=e.isUnload;if(request({url:n,data:t,success:function(e,n,t){o();try{var i=JSON.parse(t).e;if(0!==i){var a="未知错误";-2===i&&(a="事件格式错误！请检查字段类型是否正确。"),r.logger.error("数据上报失败！","错误码："+i+"。错误信息："+a),s(n,i),sdkMonitorOnError(e,n,i)}}catch(r){sdkMonitorOnError(e,n,ERROR_CODE.RESPONSE_DATA_ERROR)}},fail:function(e,n,t){r.logger.error("数据上报失败！","错误码："+t),i(n,t),sdkMonitorOnError(e,n,t)},notSure:a,isUnload:c}),!r.isSdkMonitorDisabled&&!r.isSdkOnLoadEventReady){r.isSdkOnLoadEventReady=!0;try{var u=t[0].header,l=t[0].user;sdkMonitorOnload(n,{app_id:u.app_id,app_name:u.app_name,sdk_version:u.sdk_version,web_id:l.web_id})}catch(e){}}},this.logger=n.logger||logger,this.isSdkOnLoadEventReady=!1,this.isSdkMonitorDisabled=!1},sdkMonitorOnload=function(e,n){try{var r={events:[{event:"onload",params:JSON.stringify({app_id:n.app_id,app_name:n.app_name||"",sdk_version:n.sdk_version}),local_time_ms:Date.now()}],user:{user_unique_id:n.web_id},header:{app_id:1338}};setTimeout(function(){postSdkLog(e,[r])},16)}catch(e){}},sdkMonitorOnError=function(e,n,r){try{var t=n[0].user,o=n[0].header,i=[];n.forEach(function(e){e.events.forEach(function(e){i.push(e)})});var s={events:i.map(function(e){return{event:"on_error",params:JSON.stringify({error_code:r,app_id:o.app_id,app_name:o.app_name||"",error_event:e.event,local_time_ms:e.local_time_ms,tea_event_index:Date.now(),params:e.params,header:JSON.stringify(o),user:JSON.stringify(t)}),local_time_ms:Date.now()}}),user:{user_unique_id:t.user_unique_id},header:{app_id:1338}};setTimeout(function(){postSdkLog(e,[s])},16)}catch(e){}},AppChannel=function(e){function n(r){_classCallCheck$9(this,n);var t=_possibleConstructorReturn$2(this,e.call(this));t.addListener=function(){window.addEventListener("unload",function(){t.report(!0)},!1),window.addEventListener("beforeunload",function(){t.report(!0)},!1),document.addEventListener("visibilitychange",function(){"hidden"===document.visibilityState&&t.report(!0)},!1)},t.setReady=function(e){t.isReady=e,t.eventSender.isSdkMonitorDisabled=t.isSdkMonitorDisabled,t.checkAndSendCachedStorageEvents(),t.report()},t.eventReportTimer=null,t.event=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=t.memoryCacheManager.getItem(t.evtDataCacheKey)||[],o=n?[].concat(e,r):[].concat(r,e);t.memoryCacheManager.setItem(t.evtDataCacheKey,o),o.length>=5?t.report():(t.eventReportTimer&&clearTimeout(t.eventReportTimer),t.eventReportTimer=setTimeout(function(){t.report(),t.eventReportTimer=null},t.waitForBatchTime))},t.report=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!t.isUserTokensReady)return!1;if(!t.isReady)return!1;var n=t.memoryCacheManager.getItem(t.evtDataCacheKey)||[];t.memoryCacheManager.removeItem(t.evtDataCacheKey);var r=t.mergeEnvToEvents(n);t.sendData(r,e)},t.sendData=function(e,n){var r=[],o=0,i=void 0;e.forEach(function(e){var n=!!e.__disable_storage__;void 0===i?i=n:(n!==i||r[o].length>=5)&&(o+=1,i=!i),r[o]=r[o]||[],r[o].push(e)}),r.forEach(function(e){var r=webid();e[0].__disable_storage__||t.eventStorage.add(r,e),t._sendData(r,e,n)})},t.checkAndSendCachedStorageEvents=function(){var e=t.eventStorage.getData(),n=Object.keys(e);n.length>0&&n.forEach(function(n){t._sendData(n,e[n])})},t._sendData=function(e,n,r){t.isReporting=!0;var o=function(){t.isReporting=!1};t.eventSender.send({url:t.reportUrl,data:n,success:function(){o(),t.sendDataSuccess(e)},fail:function(e,n){o(),t.reportErrorCallback(e,n),setTimeout(function(){t.report()},3e3)},eventError:function(e,n){t.reportErrorCallback(e,n)},notSure:o,isUnload:r})},t.sendDataSuccess=function(e){t.eventStorage.delete(e),t.report()};var o=r.log,i=r.disable_storage,s=r.max_batch_num,a=void 0===s?5:s,c=r.batch_time,u=void 0===c?30:c;return t.init(r),t.maxBatchNum=a,t.waitForBatchTime=u,t.isReady=!1,t.addListener(),t.enableDebugMode(!!o),t.memoryCacheManager=new StorageClient(!0),t.eventStorage=new EventStorageManager({disable_storage:i}),t.eventStorage.setStorageKey(t.evtDataCacheKey),t.eventSender=new EventSender({logger:t.logger}),t.reportErrorCallback=function(){},t}return _inherits$2(n,e),n}(AppChannelEnv),_extends$2=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var r=arguments[n];for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])}return e},getEventIndex=function(){var e=+Date.now()+Number((""+Math.random()).slice(2,8));return function(){return e+=1}}(),preprocessEvent=function(e,n){var r=e;/^event\./.test(e)&&(r=e.slice(6));var t=n;return types.isObj(t)||(t={}),t.event_index=getEventIndex(),{event:r,params:t,local_time_ms:+new Date}},Collector=function e(n){var r=this;_classCallCheck$a(this,e),this.init=function(e){if(!types.isObj(e))throw new Error("init 的参数必须是Object类型");r.logger.init(e.log),r.channel=new AppChannel(_extends$2({},e,{name:r.name})),r.channel.callback=function(){r.callbackSend&&r.start()}},this.config=function(e){types.isObj(e)||r.logger.throw("config 参数必须是 {} 的格式"),e.log&&(r.logger.init(!0),r.channel.enableDebugMode(!0),e.log=null);var n=Object.keys(e);if(!n.length)return!1;for(var t=n,o=Array.isArray(t),i=0,t=o?t:t[Symbol.iterator]();;){var s;if(o){if(i>=t.length)break;s=t[i++]}else{if((i=t.next()).done)break;s=i.value}var a=s,c=e[a];switch(a){case"evtParams":r.channel.setEvtParams(c);break;case"disable_ssid":r.logger.deprecated("(disable_ssid)请通过init函数来设置。"),c&&(r.logger.info("ssid已禁用，设置user_unique_id不会请求ssid接口。"),r.channel.isSsidDisabled=c);break;case"disable_auto_pv":c&&(r.logger.info("已禁止默认上报predefine_pageview事件，需手动上报。"),r._autoSendPV=!1);break;case"_staging_flag":""+c=="1"&&r.logger.info("根据_staging_flag设置，数据将会上报到stag 表。"),r.channel.setEvtParams({_staging_flag:Number(c)});break;case"reportErrorCallback":"function"==typeof c&&(r.channel.reportErrorCallback=c);break;default:r.channel.setEnv(a,c)}}},this.send=function(){r.start()},this.start=function(){if(r.channel.isUserTokensReady){if(r._isSendFuncCalled)return;r._isSendFuncCalled=!0,r.logger.info("看到本提示，意味着用户信息已完全就绪，上报通道打开。用户标识如下："),r.logger.logJSON(r.channel.get().user),r._autoSendPV&&r.predefinePageView(),r.channel.setReady(!0)}else r.callbackSend=!0},this.predefinePageView=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n={title:document.title||location.pathname,url:location.href,url_path:location.pathname},t=_extends$2({},n,e);r.event("predefine_pageview",t,!0)},this.event=function(){for(var e=arguments.length,n=Array(e),t=0;t<e;t++)n[t]=arguments[t];var o=types.isBoolean(n[n.length-1]),i=!!o&&n[n.length-1],s=o?n.slice(0,n.length-1):n,a=s[0],c=[];types.isArray(a)?c=s:c[0]=s,c=c.map(function(e){return preprocessEvent.apply(void 0,e)}),r.channel.event(c,i)},this._isSendFuncCalled=!1,this._autoSendPV=!0,this.name=n,this.logger=new Logger(n)};Collector.exportMethods=["init","config","send","start","predefinePageView"];var CollectorAsync=function e(n){var r=this;return _classCallCheck$b(this,e),this._exportCollect=function(){for(var e=arguments.length,n=Array(e),t=0;t<e;t++)n[t]=arguments[t];if(r._isQueueProcessed)return void r._executeCmd.apply(r,n);r.cmdQueue.push(n),r._processCmdQueue()},this._processCmdQueue=function(){if(0!==r.cmdQueue.length){var e=function(e,n,r){var t=-1;return e.forEach(function(e,o){(void 0!==r?e[r]:e)===n&&(t=o)}),t}(r.cmdQueue,"init","0");-1!==e&&(r._isQueueProcessed=!0,r._executeCmd.apply(r,r.cmdQueue[e]),r.cmdQueue.forEach(function(n,t){t!==e&&r._executeCmd.apply(r,n)}),r.cmdQueue=[])}},this._executeCmd=function(){for(var e=arguments.length,n=Array(e),t=0;t<e;t++)n[t]=arguments[t];var o=n[0];if(Collector.exportMethods.indexOf(o)>-1){var i;(i=r.colloctor)[o].apply(i,n.slice(1))}else{var s;(s=r.colloctor).event.apply(s,n)}},this.name=n||"Collector"+ +new Date,this.cmdQueue=[],this.colloctor=new Collector(this.name),this._isQueueProcessed=!1,this._processCmdQueue(),this._exportCollect.init=this._exportCollect.bind(this,"init"),this._exportCollect.config=this._exportCollect.bind(this,"config"),this._exportCollect.send=this._exportCollect.bind(this,"send"),this._exportCollect.start=this._exportCollect.bind(this,"start"),this._exportCollect.predefinePageView=this._exportCollect.bind(this,"predefinePageView"),this._exportCollect},instanceMap={},instanceCmdMap={},getInstance=function(e){return instanceMap[e]||(instanceMap[e]=new CollectorAsync(e)),instanceMap[e]},getInstanceCmdArray=function(e){return instanceCmdMap[e]||(instanceCmdMap[e]=[]),instanceCmdMap[e]},processCmdArray=function(e){var n=e[0],r=e[1],t=n.split(".");if(1===t.length)getInstanceCmdArray("default").push([n,r]);else if(2===t.length)"event"===t[0]?getInstanceCmdArray("default").push([n,r]):getInstanceCmdArray(t[0]).push([t[1],r]);else if(3===t.length){var o=t[0],i=[t[1],t[2]].join(".");getInstanceCmdArray(o).push([i,r])}},execInstanceCmds=function(e,n){n.forEach(function(n){getInstance(e).apply(void 0,n)})},processGlobalCmdQueueCache=function(){defaultCollectorClient.q.forEach(function(e){var n=[].slice.call(e);types.isArray(n[0])?n.forEach(function(e){processCmdArray(e)}):processCmdArray(n)}),Object.keys(instanceCmdMap).forEach(function(e){execInstanceCmds(e,instanceCmdMap[e]),instanceCmdMap[e]=[]}),defaultCollectorClient.q=[]},transferAsyncCollector=function(e){var n=window.TeaAnalyticsObject;if(n){if(!window[n])throw new Error("async setup code error!");var r=window[n];e.q=r.q||[],e.l=r.l||+new Date,window[n]=e}},defaultCollectorClient=function e(){for(var n=arguments.length,r=Array(n),t=0;t<n;t++)r[t]=arguments[t];e.q.push(r),processGlobalCmdQueueCache()};defaultCollectorClient.q=[],defaultCollectorClient.l=+new Date,defaultCollectorClient._instanceMap=instanceMap,defaultCollectorClient._instanceCmdMap=instanceCmdMap,defaultCollectorClient.init=defaultCollectorClient.bind(null,"init"),defaultCollectorClient.config=defaultCollectorClient.bind(null,"config"),defaultCollectorClient.send=defaultCollectorClient.bind(null,"send"),defaultCollectorClient.start=defaultCollectorClient.bind(null,"start"),defaultCollectorClient.predefinePageView=defaultCollectorClient.bind(null,"predefinePageView"),transferAsyncCollector(defaultCollectorClient),processGlobalCmdQueueCache();var Collector$1=CollectorAsync;export default defaultCollectorClient;export{Collector$1 as Collector};
