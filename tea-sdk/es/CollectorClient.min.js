function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function getVersion(e,r){var n=e.exec(r);return n&&n[1]?n[1]:""}function getAndroidVersion(e){var r=getVersion(/Android ([\.\_\d]+)/,e);return r||(r=getVersion(/Android\/([\.\_\d]+)/,e)),r}function _classCallCheck$1(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function isSupportLS(){try{return localStorage.setItem("_____tea-sdk-test-key","hi"),localStorage.getItem("_____tea-sdk-test-key"),localStorage.removeItem("_____tea-sdk-test-key"),!0}catch(e){return!1}}function _classCallCheck$2(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$3(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$4(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}function _classCallCheck$5(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function decrypto(e,r,n){if("string"==typeof e&&"number"==typeof r&&"number"==typeof n){var t=[],o=[];n=n<=25?n:n%25;var i=String.fromCharCode(n+97);t=e.split(i);for(var s=0;s<t.length;s++){var a=parseInt(t[s],n);a=1*a^r;var u=String.fromCharCode(a);o.push(u)}return o.join("")}}function b(e){return e?(e^16*Math.random()>>e/4).toString(10):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,b)}function _classCallCheck$6(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$1(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}function _inherits$1(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}function _classCallCheck$7(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$8(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$9(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn$2(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}function _inherits$2(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}function _classCallCheck$a(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _classCallCheck$b(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _extends=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},undef=void 0,Env=function e(){var r=this;_classCallCheck(this,e),this.set=function(e,n){var t=e,o=n;if(null===o)return!1;var i="";if(t.indexOf(".")>-1){var s=t.split(".");i=s[0],t=s[1]}"os_version"===t&&(o=""+o),i?"user"===i||"header"===i?r.envInfo[i][t]=o:"headers"===i?r.envInfo.header.headers[t]=o:r.envInfo.header.headers.custom[t]=o:r.envInfo.user.hasOwnProperty(t)?["user_type","device_id","ip_addr_id"].indexOf(t)>-1?r.envInfo.user[t]=Number(o):["user_id","web_id","user_unique_id","ssid"].indexOf(t)>-1?r.envInfo.user[t]=String(o):["user_is_auth","user_is_login"].indexOf(t)>-1&&(r.envInfo.user[t]=Boolean(o)):r.envInfo.header.hasOwnProperty(t)?r.envInfo.header[t]=o:r.envInfo.header.headers.hasOwnProperty(t)?r.envInfo.header.headers[t]=o:r.envInfo.header.headers.custom[t]=o},this.get=function(){for(var e={user:{},header:{headers:{custom:{}}}},n=r.envInfo,t=n.user,o=Object.keys(t),i=Array.isArray(o),s=0,o=i?o:o[Symbol.iterator]();;){var a;if(i){if(s>=o.length)break;a=o[s++]}else{if((s=o.next()).done)break;a=s.value}var u=a;t[u]!==undef&&(e.user[u]=t[u])}for(var c=n.header,d=Object.keys(c),l=Array.isArray(d),f=0,d=l?d:d[Symbol.iterator]();;){var _;if(l){if(f>=d.length)break;_=d[f++]}else{if((f=d.next()).done)break;_=f.value}var h=_;c[h]!==undef&&"headers"!==h&&(e.header[h]=c[h])}for(var p=n.header.headers,g=Object.keys(p),v=Array.isArray(g),b=0,g=v?g:g[Symbol.iterator]();;){var m;if(v){if(b>=g.length)break;m=g[b++]}else{if((b=g.next()).done)break;m=b.value}var y=m;"custom"!==y&&p[y]!==undef&&(e.header.headers[y]=p[y])}var w=n.header.headers.custom,C=Object.keys(w);if(C.length)for(var k=C,O=Array.isArray(k),S=0,k=O?k:k[Symbol.iterator]();;){var E;if(O){if(S>=k.length)break;E=k[S++]}else{if((S=k.next()).done)break;E=S.value}var I=E;e.header.headers.custom[I]=w[I]}return{user:e.user,header:_extends({},e.header,{headers:e.header.headers})}},this.envInfo={user:{user_unique_id:undef,user_type:undef,user_id:undef,user_is_auth:undef,user_is_login:undef,device_id:undef,web_id:undef,ip_addr_id:undef,ssid:undef},header:{app_id:undef,app_name:undef,app_install_id:undef,app_package:undef,app_channel:undef,app_version:undef,os_name:undef,os_version:undef,device_model:undef,ab_client:undef,ab_version:undef,traffic_type:undef,utm_source:undef,utm_medium:undef,utm_campaign:undef,client_ip:undef,device_brand:undef,os_api:undef,access:undef,language:undef,region:undef,app_language:undef,app_region:undef,creative_id:undef,ad_id:undef,campaign_id:undef,log_type:undef,rnd:undef,platform:undef,sdk_version:undef,province:undef,city:undef,timezone:undef,tz_offset:undef,tz_name:undef,sim_region:undef,carrier:undef,resolution:undef,browser:undef,browser_version:undef,referrer:undef,referrer_host:undef,headers:{utm_term:undef,utm_content:undef,custom:{}}}}},parseURL=function(e){var r=document.createElement("a");return r.href=e,r},parseUrlQuery=function(e){var r=parseURL(e).search,n={};return(r=r.slice(1)).split("&").forEach(function(e){var r=e.split("="),t=r[0],o=r[1];n[t]=decodeURIComponent(void 0===o?"":o)}),n},undef$1="",screen_width=screen.width||0,screen_height=screen.height||0,screen_size=screen_width+" x "+screen_height,appVersion=navigator.appVersion,userAgent=navigator.userAgent,language=navigator.language,referrer=document.referrer,referrer_host=parseURL(referrer).hostname,urlQueryObj=parseUrlQuery(location.href),os_name=undef$1,os_version=undef$1,browser="",browser_version=""+parseFloat(appVersion),versionOffset=void 0,semiIndex=void 0;-1!==(versionOffset=userAgent.indexOf("Opera"))&&(browser="Opera",browser_version=userAgent.substring(versionOffset+6),-1!==(versionOffset=userAgent.indexOf("Version"))&&(browser_version=userAgent.substring(versionOffset+8))),-1!==(versionOffset=userAgent.indexOf("Edge"))?(browser="Microsoft Edge",browser_version=userAgent.substring(versionOffset+5)):-1!==(versionOffset=userAgent.indexOf("MSIE"))?(browser="Microsoft Internet Explorer",browser_version=userAgent.substring(versionOffset+5)):-1!==(versionOffset=userAgent.indexOf("Chrome"))?(browser="Chrome",browser_version=userAgent.substring(versionOffset+7)):-1!==(versionOffset=userAgent.indexOf("Safari"))?(browser="Safari",browser_version=userAgent.substring(versionOffset+7),-1!==(versionOffset=userAgent.indexOf("Version"))&&(browser_version=userAgent.substring(versionOffset+8))):-1!==(versionOffset=userAgent.indexOf("Firefox"))&&(browser="Firefox",browser_version=userAgent.substring(versionOffset+8)),-1!==(semiIndex=browser_version.indexOf(";"))&&(browser_version=browser_version.substring(0,semiIndex)),-1!==(semiIndex=browser_version.indexOf(" "))&&(browser_version=browser_version.substring(0,semiIndex)),-1!==(semiIndex=browser_version.indexOf(")"))&&(browser_version=browser_version.substring(0,semiIndex));for(var platform=/Mobile|htc|mini|Android|iP(ad|od|hone)/.test(appVersion)?"wap":"web",clientOpts=[{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Android",r:/Android/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/}],i=0;i<clientOpts.length;i++){var cs=clientOpts[i];if(cs.r.test(userAgent)){os_name=cs.s;break}}switch(/Windows/.test(os_name)&&(os_version=getVersion(/Windows (.*)/,os_name),os_name="windows"),os_name){case"Mac OS X":os_version=getVersion(/Mac OS X (10[\.\_\d]+)/,userAgent),os_name="mac";break;case"Android":os_version=getAndroidVersion(userAgent),os_name="android";break;case"iOS":os_version=(os_version=/OS (\d+)_(\d+)_?(\d+)?/.exec(appVersion))?os_version[1]+"."+os_version[2]+"."+(0|os_version[3]):"",os_name="ios"}var browser$1={screen_size:screen_size,browser:browser,browser_version:browser_version,platform:platform,os_name:os_name,os_version:os_version,userAgent:userAgent,screen_width:screen_width,screen_height:screen_height,device_model:os_name,language:language,referrer:referrer,referrer_host:referrer_host,utm_source:urlQueryObj.utm_source,utm_medium:urlQueryObj.utm_medium,utm_campaign:urlQueryObj.utm_campaign,utm_term:urlQueryObj.utm_term,utm_content:urlQueryObj.utm_content},MemoryCache=function e(){var r=this;_classCallCheck$1(this,e),this.setItem=function(e,n){r.cache[e]=n},this.getItem=function(e){return r.cache[e]},this.removeItem=function(e){r.cache[e]=void 0},this.clear=function(){r.cache={}},this.cache={}};new MemoryCache;var StorageCache={getItem:function(e){try{var r=localStorage.getItem(e),n=r;try{r&&"string"==typeof r&&(n=JSON.parse(r))}catch(e){}return n||void 0}catch(e){}},setItem:function(e,r){try{var n="string"==typeof r?r:JSON.stringify(r);localStorage.setItem(e,n)}catch(e){}},removeItem:function(e){try{localStorage.removeItem(e)}catch(e){}},clear:function(){try{localStorage.clear()}catch(e){}},isSupportLS:isSupportLS()},StorageClient=function(){function e(){var r=arguments.length>0&&void 0!==arguments[0]&&arguments[0];_classCallCheck$2(this,e);var n=!r&&StorageCache.isSupportLS;this._storage=n?StorageCache:new MemoryCache}return e.prototype.getItem=function(e){return this._storage.getItem(e)},e.prototype.setItem=function(e,r){this._storage.setItem(e,r)},e.prototype.removeItem=function(e){this._storage.removeItem(e)},e.prototype.clear=function(){this._storage.clear()},e}(),TEA_CACHE_PREFIX="__tea_cache_",TEA_LOGGER_PREFIX="[tea-sdk]",ERROR_CODE={NO_URL_PREFIX:4001,IMG_ON_ERROR:4e3,IMG_CATCH_ERROR:4002,BEACON_STATUS_FALSE:4003,XHR_ON_ERROR:500,RESPONSE_DATA_ERROR:5001},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Logger=function e(){var r=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";_classCallCheck$3(this,e),this.init=function(e){r.isLog=e},this.info=function(e){for(var n=arguments.length,t=Array(n>1?n-1:0),o=1;o<n;o++)t[o-1]=arguments[o];if(r.isLog){var i;(i=console).log.apply(i,[r.prefix+e].concat(t))}},this.warn=function(e){for(var n=arguments.length,t=Array(n>1?n-1:0),o=1;o<n;o++)t[o-1]=arguments[o];if(r.isLog){var i;(i=console).warn.apply(i,[r.prefix+e].concat(t))}},this.error=function(e){for(var n=arguments.length,t=Array(n>1?n-1:0),o=1;o<n;o++)t[o-1]=arguments[o];if(r.isLog){var i;(i=console).error.apply(i,[r.prefix+e].concat(t))}},this.dir=function(){if(r.isLog){var e;(e=console).dir.apply(e,arguments)}},this.table=function(e){r.isLog&&console.table(e)},this.logJSON=function(e){"object"===(void 0===e?"undefined":_typeof(e))&&r.isLog&&r.info("",JSON.stringify(e,null,2))},this.deprecated=function(e){for(var n=arguments.length,t=Array(n>1?n-1:0),o=1;o<n;o++)t[o-1]=arguments[o];r.warn.apply(r,["[DEPRECATED]"+e].concat(t))},this.throw=function(e){throw r.error(r.prefix),new Error(e)};var t=n?"["+n+"]":"";this.prefix=TEA_LOGGER_PREFIX+t},logger=new Logger,fetchTokens=function(e,r,n,t){var o=new XMLHttpRequest;o.open("POST",e,!0),o.setRequestHeader("Content-Type","application/json; charset=utf-8"),o.onload=function(){try{var e=JSON.parse(o.responseText);n&&n(e)}catch(e){t&&t()}},o.onerror=function(){t&&t()},o.send(JSON.stringify(r))},date=new Date,timeZoneMin=date.getTimezoneOffset(),timezone=parseInt(-timeZoneMin/60,10),tz_offset=60*timeZoneMin,sdk_version=void 0;try{sdk_version="3.2.9"}catch(e){sdk_version="2.x"}var ClientEnv=function(e){function r(){_classCallCheck$4(this,r);var n=_possibleConstructorReturn(this,e.call(this));return n.initClientEnv=function(){n.set("os_name",browser$1.os_name),n.set("os_version",browser$1.os_version),n.set("device_model",browser$1.device_model),n.set("platform",browser$1.platform),n.set("sdk_version",sdk_version),n.set("browser",browser$1.browser),n.set("browser_version",browser$1.browser_version),n.set("language",browser$1.language),n.set("timezone",timezone),n.set("tz_offset",tz_offset),n.set("resolution",browser$1.screen_width+"x"+browser$1.screen_height),n.set("screen_width",browser$1.screen_width),n.set("screen_height",browser$1.screen_height),n.set("referrer",browser$1.referrer),n.set("referrer_host",browser$1.referrer_host),n.set("utm_source",browser$1.utm_source),n.set("utm_medium",browser$1.utm_medium),n.set("utm_campaign",browser$1.utm_campaign),n.set("utm_term",browser$1.utm_term),n.set("utm_content",browser$1.utm_content)},n.initClientEnv(),n}return _inherits(r,e),r}(Env),clientEnvManager=new ClientEnv,Type=function(){function e(){_classCallCheck$5(this,e)}return e.prototype.isString=function(e){return"String"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isNumber=function(e){return"Number"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isBoolean=function(e){return"Boolean"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isFunction=function(e){return"Function"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isNull=function(e){return"Null"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isUndefined=function(e){return"Undefined"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isObj=function(e){return"Object"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isArray=function(e){return"Array"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isFalse=function(e){return""===e||void 0===e||null===e||"null"===e||"undefined"===e||0===e||!1===e||NaN===e},e.prototype.isTrue=function(e){return!this.isFalse(e)},e.prototype.isLowIE=function(){return window.XDomainRequest},e}(),types=new Type,decodeXXX=function(e){return decrypto(e,64,25)},webid=function(){return b().replace(/-/g,"").slice(0,19)},_extends$1=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},urlPrefix={cn:"1fz22z22z1nz21z4mz4bz4bz1kz1az21z4az21z1lz21z21z1bz1iz4az1az1mz1k",sg:"1fz22z22z1nz21z4mz4bz4bz21z1ez18z1jz1gz49z1kz1az21z4az19z27z22z1cz1mz24z1cz20z21z1cz18z4az1az1mz1k",va:"1fz22z22z1nz21z4mz4bz4bz1kz18z1jz1gz24z18z49z1kz1az21z4az19z27z22z1cz1mz24z1cz20z21z1cz18z4az1az1mz1k"},getCookie=function(e){try{var r=document.cookie.match(new RegExp("(?:^|;)\\s*"+e+"=([^;]+)"));return decodeURIComponent(r?r[1]:"")}catch(e){return""}},AppChannelEnv=function(e){function r(){_classCallCheck$6(this,r);var n=_possibleConstructorReturn$1(this,e.call(this));return n.init=function(e){var r=e.app_id,t=e.channel,o=e.log,i=e.channel_domain,s=e.name;if("number"!=typeof r)throw new Error("app_id 必须是一个数字，注意检查是否是以`string`的方式传入的？");n.logger=new Logger(s),n.logger.init(o),n.initConfigs(e),n.initUrls(t,i),n.setEnv("app_id",r)},n.initConfigs=function(e){var r=e.app_id,t=e.disable_ssid,o=e.disable_webid,i=e.disable_sdk_monitor;n.app_id=r,n.evtDataCacheKey=TEA_CACHE_PREFIX+"events_"+r,t&&(n.logger.info("ssid已禁用，设置user_unique_id不会请求ssid接口。"),n.isSsidDisabled=!0),o&&(n.logger.info("webid服务已禁用，ssid同时被禁用。将本地生成webid。"),n.isWebidDisabled=!0,n.isSsidDisabled=!0),i&&(n.logger.info("SDK监控已禁用。"),n.isSdkMonitorDisabled=!0)},n.initUrls=function(e,r){if("internal"===e&&(n.logger.warn("channel 的值 internal 已被废弃，已自动改为 cn。"),e="cn"),!r&&!urlPrefix[e])throw new Error("channel 变量只能是 `cn`, `sg`,`va`");var t=r||decodeXXX(urlPrefix[e]);t=t.replace(/\/+$/,""),n.reportUrl=t+"/v1/list",n.userTokensPrefix=""+t},n.setEnv=function(e,r){if("app_id"===e&&n.checkUserToken(r),"user_unique_id"===e){if(n.blackUuid.some(function(e){return e===String(r)}))return void n.logger.warn('设置了无效的值 {user_unique_id："%s"}。该操作已忽略。',r);n.verifyTokens(r)}if("web_id"===e){if(!r)return;(!n.envInfo.user.user_unique_id||n.envInfo.user.user_unique_id&&n.envInfo.user.user_unique_id===n.envInfo.user.web_id)&&n.set("user_unique_id",r)}n.set(e,r)},n.transferFromCookie=function(){var e=n.tokensCacheKey,r=getCookie("tt_webid"),t=getCookie("__tea_sdk__ssid"),o=getCookie("__tea_sdk__user_unique_id");if(types.isLowIE()){if(r){var i={web_id:r,ssid:r,user_unique_id:r};n.storageClient.setItem(e,i)}return!1}if(r&&t&&o){var s={web_id:r,ssid:t,user_unique_id:o};n.storageClient.setItem(e,s)}},n.purifyBlackUuid=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(n.blackUuid.some(function(r){return r===e.user_unique_id})){var r={};return n.setUserTokens(r),n.logger.warn('检测到无效的用户标识，已重置用户状态。{user_unique_id: "%s"}',e.user_unique_id),r}return e},n.getUserTokens=function(){return n.storageClient.getItem(n.tokensCacheKey)||{}},n.setUserTokens=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return n.storageClient.setItem(n.tokensCacheKey,e)},n.checkUserToken=function(e){var r=TEA_CACHE_PREFIX+"tokens_"+e;n.tokensCacheKey=r,n.transferFromCookie();var t=n.purifyBlackUuid(n.getUserTokens());t.user_unique_id&&t.web_id?(n.envInfo.user.user_unique_id=t.user_unique_id,n.envInfo.user.web_id=t.web_id,n.envInfo.user.ssid=t.ssid||"",n.logger.info("初始化已经检测到了 webid user_unique_id，一般情况下不需要再次验证 id 了"),n.unlock()):n.requestWebId(e)},n.saveTokenToStorage=function(e){var r=e.web_id,t=e.ssid,o=e.user_unique_id;n.setUserTokens({web_id:r,ssid:t,user_unique_id:o})},n.requestWebId=function(){n.isRequestWebId=!0;var e=function(e){var r=n.envInfo.user.web_id||e.web_id,t=e.ssid;n.isRequestWebId=!1,n.envInfo.user.ssid=t,n.envInfo.user.web_id=r,n.envInfo.user.user_unique_id=r,n.saveTokenToStorage({web_id:r,ssid:t,user_unique_id:r}),n.waitForVerifyTokens?(n.lock(),n.verifyTokens(n.realUuid)):(n.unlock(),n.callback&&n.callback())};n.isWebidDisabled?function(){e({web_id:webid(),ssid:""})}():function(){var r=n.userTokensPrefix+"/v1/user/webid";fetchTokens(r,{app_id:n.app_id,url:location.href,user_agent:browser$1.userAgent,referer:browser$1.referrer,user_unique_id:""},function(r){0!==r.e?n.logger.error("请求 webid 失败。请联系管理员。"):e(r)},function(){n.isRequestWebId=!1,n.logger.error("获取 webid 失败，数据将不会被上报")})}()},n.verifyTokens=function(e){var r=n.tokensCacheKey;if(n.waitForVerifyTokens=!1,n.realUuid=""+e,n.isRequestWebId)return n.waitForVerifyTokens=!0,n.logger.info("正在请求 webid，requestSsid 将会在前者请求完毕之后被调用"),!1;var t=n.getUserTokens();if(t.user_unique_id===n.realUuid&&t.ssid&&t.web_id)n.logger.info("传入的 user_id/user_unique_id 与 缓存中的完全一致，无需再次请求"),n.unlock();else{n.lock(),n.envInfo.user.user_unique_id=n.realUuid;var o=_extends$1({},n.getUserTokens(),{user_unique_id:n.realUuid});if(n.storageClient.setItem(r,o),types.isLowIE())return n.unlock(),!1;n.isSsidDisabled?(n.unlock(),n.callback&&n.callback()):n.requestSsid()}},n.requestSsid=function(){var e=n.getUserTokens(),r=n.userTokensPrefix+"/v1/user/ssid";fetchTokens(r,{app_id:n.app_id,web_id:e.web_id,user_unique_id:""+e.user_unique_id},function(r){if(n.unlock(),0!==r.e)n.logger.error("请求 ssid 失败~");else{n.envInfo.user.ssid=r.ssid;var t=_extends$1({},e,{ssid:r.ssid});n.setUserTokens(t),n.logger.info("根据 user_unique_id 更新 ssid 成功！注意：在这之前不应该有数据被发出去"),n.callback&&n.callback()}},function(){n.unlock(),n.logger.error("根据 user_unique_id 获取新 ssid 失败")})},n.setEvtParams=function(e){var r=_extends$1({},e);Object.keys(r).forEach(function(e){n.evtParams[e]=r[e]})},n.mergeEnvToEvents=function(e){var r=n.mergeEnv(),t=[],o=0,i=void 0;return e.forEach(function(e){var r=!!e.params.__disable_storage__;void 0===i?i=r:(r!==i||t[o].length>=5)&&(o+=1,i=!i),t[o]=t[o]||[],t[o].push(e)}),t.map(function(e){return{events:e.map(function(e){var r=_extends$1({},n.evtParams,e.params);return delete r.__disable_storage__,_extends$1({},e,{params:JSON.stringify(r)})}),user:r.user,header:r.header,verbose:n.debugMode?1:void 0,__disable_storage__:e[0].params.__disable_storage__}})},n.mergeEnv=function(){var e=n.get(),r=clientEnvManager.get(),t=_extends$1({},e.user),o=_extends$1({},r.header.headers.custom,e.header.headers.custom),i=_extends$1({},r.header.headers,e.header.headers,{custom:o}),s=_extends$1({},r.header,e.header);return{user:t,header:_extends$1({},s,{headers:JSON.stringify(i)})}},n.evtParams={},n.reportUrl="",n.userTokensPrefix="",n.isSsidDisabled=!1,n.isWebidDisabled=!1,n.isSdkMonitorDisabled=!1,n.debugMode=!1,n.blackUuid=["null","undefined","0","","None"],n.logger=function(){},n.storageClient=new StorageClient,n}return _inherits$1(r,e),r.prototype.lock=function(){this.isUserTokensReady=!1},r.prototype.unlock=function(){this.isUserTokensReady=!0},r.prototype.enableDebugMode=function(e){this.debugMode=e},r}(Env),EventStorageManager=function(){function e(r){var n=r.disable_storage,t=void 0!==n&&n;_classCallCheck$7(this,e),this._storage=new StorageClient(t),this._storageKey="",this._data=void 0}return e.prototype.setStorageKey=function(e){this._storageKey=e},e.prototype.getAllEvents=function(){var e=this.getData();Object.keys(e).reduce(function(r,n){return r.concat(e[n]||[])},[])},e.prototype.getData=function(){return this._checkIsDataInit(),this._data},e.prototype.add=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this._checkIsDataInit(),0!==r.length&&(this._data[e]=r,this._save())},e.prototype.delete=function(e){this._checkIsDataInit(),this._data[e]&&(delete this._data[e],this._save())},e.prototype._checkIsDataInit=function(){if(void 0===this._data)try{var e=this._getDataFromStorage();if(types.isArray(e)){var r;this._data=(r={},r[webid()]=e,r),this._save()}else this._data=e}catch(e){this._data={}}},e.prototype._checkStorageKey=function(){if(!this._storageKey)throw new Error("must call setStorageKey('xxx') first")},e.prototype._getDataFromStorage=function(){return this._checkStorageKey(),this._storage.getItem(this._storageKey)||{}},e.prototype._save=function(){this._checkStorageKey(),this._storage.setItem(this._storageKey,this._data)},e}(),encodePayload=function(e){var r="";for(var n in e)e.hasOwnProperty(n)&&(r+="&"+n+"="+encodeURIComponent(JSON.stringify(e[n])));return r="&"===r[0]?r.slice(1):r},sendByImg=function(e,r){try{var n=e.split("v1")[0];r.forEach(function(e){var r=encodePayload(e),t=new Image(1,1);t.onload=function(){t=null},t.onerror=function(){t=null},t.src=n+"/v1/gif?"+r})}catch(e){}},postSdkLog=function(e,r){if(window.XDomainRequest)return sendByImg(e,r);var n=new XMLHttpRequest;n.open("POST",e+"?rdn="+Math.random(),!0),n.onload=function(){},n.onerror=function(){n.abort()},n.send(JSON.stringify(r))},encodePayload$1=function(e){var r="";for(var n in e)e.hasOwnProperty(n)&&(r+="&"+n+"="+encodeURIComponent(JSON.stringify(e[n])));return r="&"===r[0]?r.slice(1):r},sendByImg$1=function(e,r,n,t){try{var o=e.split("v1")[0];if(!o)return void t(e,r,ERROR_CODE.NO_URL_PREFIX);r.forEach(function(i){var s=encodePayload$1(i),a=new Image(1,1);a.onload=function(){a=null,n()},a.onerror=function(){a=null,t(e,r,ERROR_CODE.IMG_ON_ERROR)},a.src=o+"/v1/gif?"+s})}catch(n){t(e,r,ERROR_CODE.IMG_CATCH_ERROR,n.message)}},request=function(e){var r=e.url,n=e.data,t=e.success,o=e.fail,i=e.notSure,s=e.isUnload,a=n;if(window.XDomainRequest)return void sendByImg$1(r,a,t,o);if(s)return window.navigator&&window.navigator.sendBeacon?(i(),void(window.navigator.sendBeacon(r,JSON.stringify(a))?t():o(r,n,ERROR_CODE.BEACON_STATUS_FALSE))):void sendByImg$1(r,a,t,o);var u=new XMLHttpRequest;u.open("POST",r+"?rdn="+Math.random(),!0),u.onload=function(){t(r,a,u.responseText)},u.onerror=function(){u.abort(),o(r,a,ERROR_CODE.XHR_ON_ERROR)},u.send(JSON.stringify(a))},EventSender=function e(r){var n=this;_classCallCheck$8(this,e),this.send=function(e){var r=e.url,t=e.data,o=e.success,i=e.fail,s=e.eventError,a=e.notSure,u=e.isUnload;if(request({url:r,data:t,success:function(e,r,t){o();try{var i=JSON.parse(t).e;if(0!==i){var a="未知错误";-2===i&&(a="事件格式错误！请检查字段类型是否正确。"),n.logger.error("数据上报失败！","错误码："+i+"。错误信息："+a),s(r,i),sdkMonitorOnError(e,r,i)}}catch(n){sdkMonitorOnError(e,r,ERROR_CODE.RESPONSE_DATA_ERROR)}},fail:function(e,r,t){n.logger.error("数据上报失败！","错误码："+t),i(r,t),sdkMonitorOnError(e,r,t)},notSure:a,isUnload:u}),!n.isSdkMonitorDisabled&&!n.isSdkOnLoadEventReady){n.isSdkOnLoadEventReady=!0;try{var c=t[0].header,d=t[0].user;sdkMonitorOnload(r,{app_id:c.app_id,app_name:c.app_name,sdk_version:c.sdk_version,web_id:d.web_id})}catch(e){}}},this.logger=r.logger||logger,this.isSdkOnLoadEventReady=!1,this.isSdkMonitorDisabled=!1},sdkMonitorOnload=function(e,r){try{var n={events:[{event:"onload",params:JSON.stringify({app_id:r.app_id,app_name:r.app_name||"",sdk_version:r.sdk_version}),local_time_ms:Date.now()}],user:{user_unique_id:r.web_id},header:{app_id:1338}};setTimeout(function(){postSdkLog(e,[n])},16)}catch(e){}},sdkMonitorOnError=function(e,r,n){try{var t=r[0].user,o=r[0].header,i=[];r.forEach(function(e){e.events.forEach(function(e){i.push(e)})});var s={events:i.map(function(e){return{event:"on_error",params:JSON.stringify({error_code:n,app_id:o.app_id,app_name:o.app_name||"",error_event:e.event,local_time_ms:e.local_time_ms,tea_event_index:Date.now(),params:e.params,header:JSON.stringify(o),user:JSON.stringify(t)}),local_time_ms:Date.now()}}),user:{user_unique_id:t.user_unique_id},header:{app_id:1338}};setTimeout(function(){postSdkLog(e,[s])},16)}catch(e){}},AppChannel=function(e){function r(n){_classCallCheck$9(this,r);var t=_possibleConstructorReturn$2(this,e.call(this));t.addListener=function(){window.addEventListener("unload",function(){t.report(!0)},!1),window.addEventListener("beforeunload",function(){t.report(!0)},!1),document.addEventListener("visibilitychange",function(){"hidden"===document.visibilityState&&t.report(!0)},!1)},t.setReady=function(e){t.isReady=e,t.eventSender.isSdkMonitorDisabled=t.isSdkMonitorDisabled,t.checkAndSendCachedStorageEvents(),t.report()},t.eventReportTimer=null,t.event=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=t.memoryCacheManager.getItem(t.evtDataCacheKey)||[],o=r?[].concat(e,n):[].concat(n,e);t.memoryCacheManager.setItem(t.evtDataCacheKey,o),o.length>=5?t.report():(t.eventReportTimer&&clearTimeout(t.eventReportTimer),t.eventReportTimer=setTimeout(function(){t.report(),t.eventReportTimer=null},t.waitForBatchTime))},t.report=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!t.isUserTokensReady)return!1;if(!t.isReady)return!1;var r=t.memoryCacheManager.getItem(t.evtDataCacheKey)||[];t.memoryCacheManager.removeItem(t.evtDataCacheKey);var n=t.mergeEnvToEvents(r);t.sendData(n,e)},t.sendData=function(e,r){var n=[],o=0,i=void 0;e.forEach(function(e){var r=!!e.__disable_storage__;void 0===i?i=r:(r!==i||n[o].length>=5)&&(o+=1,i=!i),n[o]=n[o]||[],n[o].push(e)}),n.forEach(function(e){var n=webid();e[0].__disable_storage__||t.eventStorage.add(n,e),t._sendData(n,e,r)})},t.checkAndSendCachedStorageEvents=function(){var e=t.eventStorage.getData(),r=Object.keys(e);r.length>0&&r.forEach(function(r){t._sendData(r,e[r])})},t._sendData=function(e,r,n){t.isReporting=!0;var o=function(){t.isReporting=!1};t.eventSender.send({url:t.reportUrl,data:r,success:function(){o(),t.sendDataSuccess(e)},fail:function(e,r){o(),t.reportErrorCallback(e,r),setTimeout(function(){t.report()},3e3)},eventError:function(e,r){t.reportErrorCallback(e,r)},notSure:o,isUnload:n})},t.sendDataSuccess=function(e){t.eventStorage.delete(e),t.report()};var o=n.log,i=n.disable_storage,s=n.max_batch_num,a=void 0===s?5:s,u=n.batch_time,c=void 0===u?30:u;return t.init(n),t.maxBatchNum=a,t.waitForBatchTime=c,t.isReady=!1,t.addListener(),t.enableDebugMode(!!o),t.memoryCacheManager=new StorageClient(!0),t.eventStorage=new EventStorageManager({disable_storage:i}),t.eventStorage.setStorageKey(t.evtDataCacheKey),t.eventSender=new EventSender({logger:t.logger}),t.reportErrorCallback=function(){},t}return _inherits$2(r,e),r}(AppChannelEnv),_extends$2=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},getEventIndex=function(){var e=+Date.now()+Number((""+Math.random()).slice(2,8));return function(){return e+=1}}(),preprocessEvent=function(e,r){var n=e;/^event\./.test(e)&&(n=e.slice(6));var t=r;return types.isObj(t)||(t={}),t.event_index=getEventIndex(),{event:n,params:t,local_time_ms:+new Date}},Collector=function e(r){var n=this;_classCallCheck$a(this,e),this.init=function(e){if(!types.isObj(e))throw new Error("init 的参数必须是Object类型");n.logger.init(e.log),n.channel=new AppChannel(_extends$2({},e,{name:n.name})),n.channel.callback=function(){n.callbackSend&&n.start()}},this.config=function(e){types.isObj(e)||n.logger.throw("config 参数必须是 {} 的格式"),e.log&&(n.logger.init(!0),n.channel.enableDebugMode(!0),e.log=null);var r=Object.keys(e);if(!r.length)return!1;for(var t=r,o=Array.isArray(t),i=0,t=o?t:t[Symbol.iterator]();;){var s;if(o){if(i>=t.length)break;s=t[i++]}else{if((i=t.next()).done)break;s=i.value}var a=s,u=e[a];switch(a){case"evtParams":n.channel.setEvtParams(u);break;case"disable_ssid":n.logger.deprecated("(disable_ssid)请通过init函数来设置。"),u&&(n.logger.info("ssid已禁用，设置user_unique_id不会请求ssid接口。"),n.channel.isSsidDisabled=u);break;case"disable_auto_pv":u&&(n.logger.info("已禁止默认上报predefine_pageview事件，需手动上报。"),n._autoSendPV=!1);break;case"_staging_flag":""+u=="1"&&n.logger.info("根据_staging_flag设置，数据将会上报到stag 表。"),n.channel.setEvtParams({_staging_flag:Number(u)});break;case"reportErrorCallback":"function"==typeof u&&(n.channel.reportErrorCallback=u);break;default:n.channel.setEnv(a,u)}}},this.send=function(){n.start()},this.start=function(){if(n.channel.isUserTokensReady){if(n._isSendFuncCalled)return;n._isSendFuncCalled=!0,n.logger.info("看到本提示，意味着用户信息已完全就绪，上报通道打开。用户标识如下："),n.logger.logJSON(n.channel.get().user),n._autoSendPV&&n.predefinePageView(),n.channel.setReady(!0)}else n.callbackSend=!0},this.predefinePageView=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r={title:document.title||location.pathname,url:location.href,url_path:location.pathname},t=_extends$2({},r,e);n.event("predefine_pageview",t,!0)},this.event=function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];var o=types.isBoolean(r[r.length-1]),i=!!o&&r[r.length-1],s=o?r.slice(0,r.length-1):r,a=s[0],u=[];types.isArray(a)?u=s:u[0]=s,u=u.map(function(e){return preprocessEvent.apply(void 0,e)}),n.channel.event(u,i)},this._isSendFuncCalled=!1,this._autoSendPV=!0,this.name=r,this.logger=new Logger(r)};Collector.exportMethods=["init","config","send","start","predefinePageView"];var CollectorAsync=function e(r){var n=this;return _classCallCheck$b(this,e),this._exportCollect=function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];if(n._isQueueProcessed)return void n._executeCmd.apply(n,r);n.cmdQueue.push(r),n._processCmdQueue()},this._processCmdQueue=function(){if(0!==n.cmdQueue.length){var e=function(e,r,n){var t=-1;return e.forEach(function(e,o){(void 0!==n?e[n]:e)===r&&(t=o)}),t}(n.cmdQueue,"init","0");-1!==e&&(n._isQueueProcessed=!0,n._executeCmd.apply(n,n.cmdQueue[e]),n.cmdQueue.forEach(function(r,t){t!==e&&n._executeCmd.apply(n,r)}),n.cmdQueue=[])}},this._executeCmd=function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];var o=r[0];if(Collector.exportMethods.indexOf(o)>-1){var i;(i=n.colloctor)[o].apply(i,r.slice(1))}else{var s;(s=n.colloctor).event.apply(s,r)}},this.name=r||"Collector"+ +new Date,this.cmdQueue=[],this.colloctor=new Collector(this.name),this._isQueueProcessed=!1,this._processCmdQueue(),this._exportCollect.init=this._exportCollect.bind(this,"init"),this._exportCollect.config=this._exportCollect.bind(this,"config"),this._exportCollect.send=this._exportCollect.bind(this,"send"),this._exportCollect.start=this._exportCollect.bind(this,"start"),this._exportCollect.predefinePageView=this._exportCollect.bind(this,"predefinePageView"),this._exportCollect};export default CollectorAsync;
